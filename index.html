<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج إدارة مصنع البحص - النظام المالي المتكامل</title>
    
    <!-- مكتبة الأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        /* صفحة الدخول */
        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            padding: 40px;
            text-align: center;
        }
        
        .company-header {
            margin-bottom: 30px;
        }
        
        .company-logo {
            max-width: 120px;
            max-height: 120px;
            margin-bottom: 15px;
            border-radius: 10px;
            object-fit: contain;
        }
        
        .logo-placeholder {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 auto 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .login-form input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .login-form input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        .login-btn {
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .test-credentials {
            margin-top: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 14px;
            color: #666;
        }
        
        /* التطبيق الرئيسي */
        .app-container {
            display: none;
            width: 100%;
            max-width: 1400px;
            margin: 20px auto;
            min-height: 95vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .top-bar {
            background: linear-gradient(to right, #2c3e50, #34495e);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .company-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .top-logo {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }
        
        .top-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .financial-year-info {
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .main-content {
            display: flex;
            min-height: calc(95vh - 70px);
        }
        
        .sidebar {
            width: 250px;
            background: #f8f9fa;
            border-left: 1px solid #eee;
            padding: 20px;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .menu-item {
            padding: 15px;
            margin: 5px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
        }
        
        .menu-item:hover {
            background: #e9ecef;
        }
        
        .menu-item.active {
            background: #667eea;
            color: white;
        }
        
        .content-area {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }
        
        .page-header {
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 5px solid #667eea;
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .stat-card i {
            font-size: 40px;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .form-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        .btn {
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-info {
            background: #3498db;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .filter-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content-large {
            max-width: 800px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .toggle-credentials {
            background: #f8f9fa;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 20px;
            cursor: pointer;
            width: 100%;
        }
        
        .toggle-credentials:hover {
            background: #e9ecef;
        }
        
        .data-empty {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .data-empty i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        .sales-table {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .sales-item-row {
            background: #f8f9fa;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .invoice-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .invoice-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .invoice-total {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
            font-size: 18px;
            font-weight: bold;
        }
        
        .profit {
            color: #27ae60;
            font-weight: bold;
        }
        
        .loss {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .signature-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }
        
        .signature-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .signature-box {
            text-align: center;
            padding: 15px;
            border: 1px dashed #ddd;
            border-radius: 8px;
        }
        
        .payment-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .report-logo {
            max-width: 150px;
            max-height: 150px;
            margin-bottom: 20px;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .company-report-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .company-report-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .company-report-header p {
            color: #666;
            margin: 5px 0;
        }
        
        .print-button {
            margin-top: 20px;
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .production-items-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .year-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .year-status.open {
            background: #27ae60;
            color: white;
        }
        
        .year-status.closed {
            background: #e74c3c;
            color: white;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .production-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        
        .production-item-row button {
            padding: 5px 10px;
            height: fit-content;
        }
    </style>
</head>
<body>
    <!-- صفحة تسجيل الدخول -->
    <div class="login-container" id="loginPage">
        <div class="company-header">
            <img src="" alt="شعار الشركة" class="company-logo" id="loginCompanyLogo" style="display: none;">
            <div class="logo-placeholder" id="loginLogoPlaceholder">
                <i class="fas fa-industry"></i>
            </div>
            <h1 id="loginCompanyName">برنامج إدارة مصنع البحص</h1>
            <p id="loginCompanySlogan">نظام السنة المالية المتكاملة</p>
        </div>
        
        <div class="login-form">
            <input type="text" id="username" placeholder="اسم المستخدم" value="admin">
            <input type="password" id="password" placeholder="كلمة المرور" value="123456">
            <button class="login-btn" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
            </button>
        </div>
        
       
        
        
            
        </button>
    </div>
    
    <!-- التطبيق الرئيسي -->
    <div class="app-container" id="appContainer">
        <!-- الشريط العلوي -->
        <div class="top-bar">
            <div class="company-info">
                <div class="top-logo" id="topLogo">
                    <img src="" alt="شعار الشركة" id="topLogoImg" style="display: none;">
                    <i class="fas fa-industry" id="topLogoIcon"></i>
                </div>
                <div>
                    <h3 id="appCompanyName">مصنع إنتاج البحص</h3>
                    <div id="appCompanyInfo" style="font-size: 12px; color: #bdc3c7;">نظام الإدارة المالية</div>
                </div>
            </div>
            
            <div class="financial-year-info" id="financialYearInfo">
                <i class="fas fa-calendar-alt"></i> السنة المالية: <span id="currentYear">2024</span>
                <span id="yearStatusBadge" class="year-status open" style="margin-right: 10px;">مفتوحة</span>
            </div>
            
            <div class="user-info">
                <div style="text-align: left;">
                    <div id="currentUserName">المدير</div>
                    <div style="font-size: 12px; color: #bdc3c7;" id="currentUserRole">مدير النظام</div>
                </div>
                <div class="user-avatar" id="userAvatar">م</div>
                <button class="btn btn-secondary" onclick="showChangePassword()" style="padding: 8px 15px;">
                    <i class="fas fa-lock"></i>
                </button>
                <button class="btn btn-danger" onclick="logout()" style="padding: 8px 15px;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
        
        <!-- المحتوى الرئيسي -->
        <div class="main-content">
            <!-- الشريط الجانبي -->
            <div class="sidebar">
                <div class="sidebar-menu">
                    <div class="menu-item active" onclick="showPage('dashboard')">
                        <i class="fas fa-home"></i> الرئيسية
                    </div>
                    <div class="menu-item" onclick="showPage('items')">
                        <i class="fas fa-boxes"></i> الأصناف
                    </div>
                    <div class="menu-item" onclick="showPage('openingInventory')">
                        <i class="fas fa-box-open"></i> المخزون الافتتاحي
                    </div>
                    <div class="menu-item" onclick="showPage('customers')">
                        <i class="fas fa-users"></i> العملاء
                    </div>
                    <div class="menu-item" onclick="showPage('production')">
                        <i class="fas fa-industry"></i> الإنتاج اليومي
                    </div>
                    <div class="menu-item" onclick="showPage('salesOrders')">
                        <i class="fas fa-clipboard-list"></i> أوامر البيع
                    </div>
                    <div class="menu-item" onclick="showPage('sales')">
                        <i class="fas fa-shopping-cart"></i> المبيعات
                    </div>
                    <div class="menu-item" onclick="showPage('expenses')">
                        <i class="fas fa-money-bill"></i> المصاريف
                    </div>
                    <div class="menu-item" onclick="showPage('costCalculation')">
                        <i class="fas fa-calculator"></i> حساب التكلفة
                    </div>
                    <div class="menu-item" onclick="showPage('reports')">
                        <i class="fas fa-chart-bar"></i> التقارير
                    </div>
                    <div class="menu-item" onclick="showPage('payments')">
                        <i class="fas fa-credit-card"></i> سداد المدفوعات
                    </div>
                    <div class="menu-item" onclick="showPage('financialYears')">
                        <i class="fas fa-calendar"></i> السنوات المالية
                    </div>
                    <div class="menu-item" onclick="showPage('users')">
                        <i class="fas fa-user-cog"></i> إدارة المستخدمين
                    </div>
                    <div class="menu-item" onclick="showPage('settings')">
                        <i class="fas fa-cog"></i> الإعدادات
                    </div>
                </div>
            </div>
            
            <!-- منطقة المحتوى -->
            <div class="content-area" id="contentArea">
                <!-- سيتم تحميل المحتوى هنا -->
            </div>
        </div>
    </div>

    <!-- نافذة تغيير كلمة المرور -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <h2><i class="fas fa-lock"></i> تغيير كلمة المرور</h2>
            <div class="form-group">
                <label>كلمة المرور الحالية:</label>
                <input type="password" id="currentPassword" placeholder="كلمة المرور الحالية">
            </div>
            <div class="form-group">
                <label>كلمة المرور الجديدة:</label>
                <input type="password" id="newPassword" placeholder="كلمة المرور الجديدة">
            </div>
            <div class="form-group">
                <label>تأكيد كلمة المرور الجديدة:</label>
                <input type="password" id="confirmPassword" placeholder="تأكيد كلمة المرور">
            </div>
            <div class="password-requirements">
                <p><strong>متطلبات كلمة المرور:</strong></p>
                <ul>
                    <li id="reqLength">٦ أحرف على الأقل</li>
                </ul>
            </div>
            <button class="btn btn-success" onclick="changePassword()">
                <i class="fas fa-save"></i> حفظ التغييرات
            </button>
            <button class="btn btn-secondary" onclick="closeModal('changePasswordModal')" style="margin-right: 10px;">
                إلغاء
            </button>
        </div>
    </div>

    <!-- نافذة عرض الفاتورة -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content modal-content-large">
            <h2><i class="fas fa-file-invoice"></i> فاتورة بيع</h2>
            <div id="invoiceContent">
                <!-- سيتم تحميل محتوى الفاتورة هنا -->
            </div>
            <button class="btn" onclick="printInvoice()" style="margin-top: 20px;">
                <i class="fas fa-print"></i> طباعة الفاتورة
            </button>
            <button class="btn btn-secondary" onclick="closeModal('invoiceModal')" style="margin-right: 10px; margin-top: 20px;">
                إغلاق
            </button>
        </div>
    </div>

    <!-- نافذة طباعة سند الإنتاج -->
    <div class="modal" id="printProductionModal">
        <div class="modal-content modal-content-large">
            <h2><i class="fas fa-print"></i> طباعة سند الإنتاج</h2>
            <div id="printProductionContent">
                <!-- سيتم تحميل محتوى السند هنا -->
            </div>
            <button class="btn" onclick="printProductionDocument()" style="margin-top: 20px;">
                <i class="fas fa-print"></i> طباعة السند
            </button>
            <button class="btn btn-secondary" onclick="closeModal('printProductionModal')" style="margin-right: 10px; margin-top: 20px;">
                إغلاق
            </button>
        </div>
    </div>

    <!-- نافذة سداد الفاتورة -->
    <div class="modal" id="paymentModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2><i class="fas fa-credit-card"></i> سداد فاتورة</h2>
            <div id="paymentContent">
                <!-- سيتم تحميل محتوى السداد هنا -->
            </div>
        </div>
    </div>

    <!-- نافذة طباعة أمر البيع -->
    <div class="modal" id="printOrderModal">
        <div class="modal-content modal-content-large">
            <h2><i class="fas fa-print"></i> طباعة أمر بيع</h2>
            <div id="printOrderContent">
                <!-- سيتم تحميل محتوى أمر البيع هنا -->
            </div>
            <button class="btn" onclick="printOrderDocument()" style="margin-top: 20px;">
                <i class="fas fa-print"></i> طباعة الأمر
            </button>
            <button class="btn btn-secondary" onclick="closeModal('printOrderModal')" style="margin-right: 10px; margin-top: 20px;">
                إغلاق
            </button>
        </div>
    </div>

    <script>
        // ========== متغيرات النظام ==========
        let currentUser = null;
        let companyInfo = {
            name: "مصنع إنتاج البحص",
            address: "الرياض - طريق الملك فهد",
            phone: "0112345678",
            email: "info@factory.com",
            taxNumber: "123456789012345",
            taxRate: 15,
            logo: "",
            exchangeRate: 1.0
        };
        
        let currentFinancialYear = new Date().getFullYear();
        let financialYears = [];
        
        // ========== إدارة التخزين ==========
        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }
        
        function loadData(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }
        
        // ========== تهيئة النظام ==========
        function initializeSystem() {
            // تهيئة بيانات الشركة
            const savedCompany = localStorage.getItem('companyInfo');
            if (savedCompany) {
                companyInfo = JSON.parse(savedCompany);
                updateCompanyUI();
            }
            
            // تهيئة السنوات المالية
            const savedYears = localStorage.getItem('financialYears');
            if (savedYears) {
                financialYears = JSON.parse(savedYears);
            } else {
                const currentYear = new Date().getFullYear();
                financialYears = [
                    {
                        year: currentYear,
                        status: 'open',
                        openingBalance: 0,
                        openingDate: `${currentYear}-01-01`,
                        closingDate: null,
                        totalSales: 0,
                        totalExpenses: 0,
                        netProfit: 0
                    }
                ];
                saveData('financialYears', financialYears);
            }
            
            // تعيين السنة المالية الحالية
            const openYear = financialYears.find(y => y.status === 'open');
            if (openYear) {
                currentFinancialYear = openYear.year;
            }
            
            // تحديث واجهة السنة المالية
            updateFinancialYearUI();
            
            // تهيئة المستخدمين
            if (!loadData('users').length) {
                const defaultUsers = [
                    {
                        id: 1,
                        username: "admin",
                        password: "123456",
                        name: "المدير العام",
                        role: "admin",
                        email: "admin@factory.com",
                        avatar: "م"
                    },
                    {
                        id: 2,
                        username: "user",
                        password: "123456",
                        name: "أحمد محمد",
                        role: "user",
                        email: "user@factory.com",
                        avatar: "أ"
                    }
                ];
                saveData('users', defaultUsers);
            }
            
            // تهيئة الأصناف
            if (!loadData('items').length) {
                const defaultItems = [
                    {id: 1, code: "1001", name: "بحص خشن", unit: "طن", price: 250, stock: 1500, openingStock: 1500, cost: 180, minStock: 100},
                    {id: 2, code: "1002", name: "بحص ناعم", unit: "طن", price: 280, stock: 800, openingStock: 800, cost: 210, minStock: 50},
                    {id: 3, code: "1003", name: "بحص متوسط", unit: "طن", price: 230, stock: 1200, openingStock: 1200, cost: 160, minStock: 80}
                ];
                saveData('items', defaultItems);
            }
            
            // تهيئة العملاء
            if (!loadData('customers').length) {
                const defaultCustomers = [
                    {id: 1, code: "2001", name: "شركة التعمير", phone: "0555123456", address: "الرياض", email: "info@altaamir.com", taxNumber: "100001234567890", balance: 0},
                    {id: 2, code: "2002", name: "مؤسسة الرشد", phone: "0555654321", address: "الرياض", email: "sales@alrushd.com", taxNumber: "100002345678901", balance: 0},
                    {id: 3, code: "2003", name: "شركة البناء الحديث", phone: "0555789123", address: "الرياض", email: "contact@modernbuild.com", taxNumber: "100003456789012", balance: 0}
                ];
                saveData('customers', defaultCustomers);
            }
            
            // تهيئة تكاليف الإنتاج الشهرية
            if (!loadData('productionCosts').length) {
                const today = new Date();
                const defaultCosts = [
                    {
                        id: 1,
                        month: today.getMonth() + 1,
                        year: today.getFullYear(),
                        itemId: 1,
                        itemName: "بحص خشن",
                        productionCost: 150,
                        additionalCosts: 30,
                        totalCost: 180,
                        notes: "تكلفة أساسية"
                    }
                ];
                saveData('productionCosts', defaultCosts);
            }
            
            // تهيئة المصاريف
            if (!loadData('expenses').length) {
                const today = new Date().toISOString().split('T')[0];
                const defaultExpenses = [
                    {
                        id: 1,
                        date: today,
                        type: "مرتبات",
                        amount: 50000,
                        description: "مرتبات الموظفين لشهر",
                        createdBy: 1,
                        financialYear: currentFinancialYear
                    },
                    {
                        id: 2,
                        date: today,
                        type: "كهرباء",
                        amount: 15000,
                        description: "فاتورة الكهرباء",
                        createdBy: 1,
                        financialYear: currentFinancialYear
                    }
                ];
                saveData('expenses', defaultExpenses);
            }
            
            // تهيئة أوامر البيع
            if (!loadData('salesOrders').length) {
                const today = new Date().toISOString().split('T')[0];
                const defaultOrders = [
                    {
                        id: 1,
                        orderNo: "ORD-2024-001",
                        date: today,
                        customerId: 1,
                        customerName: "شركة التعمير",
                        items: [
                            {itemId: 1, itemName: "بحص خشن", quantity: 50, price: 250, total: 12500}
                        ],
                        subtotal: 12500,
                        tax: 1875,
                        total: 14375,
                        status: "pending",
                        notes: "تسليم خلال أسبوع",
                        createdBy: 1,
                        financialYear: currentFinancialYear
                    }
                ];
                saveData('salesOrders', defaultOrders);
            }
            
            // تهيئة المبيعات
            if (!loadData('sales').length) {
                const today = new Date().toISOString().split('T')[0];
                const defaultSales = [
                    {
                        id: 1,
                        invoiceNo: "INV-2024-001",
                        date: today,
                        customerId: 1,
                        customerName: "شركة التعمير",
                        items: [
                            {itemId: 1, itemName: "بحص خشن", quantity: 50, price: 250, total: 12500}
                        ],
                        subtotal: 12500,
                        discount: 0,
                        tax: 1875,
                        total: 14375,
                        paid: 14375,
                        balance: 0,
                        status: "completed",
                        createdBy: 1,
                        isReturn: false,
                        orderId: 1,
                        financialYear: currentFinancialYear
                    }
                ];
                saveData('sales', defaultSales);
            }
            
            // تهيئة الإنتاج اليومي
            if (!loadData('production').length) {
                const today = new Date().toISOString().split('T')[0];
                const defaultProduction = [
                    {
                        id: 1,
                        date: today,
                        items: [
                            {itemId: 1, itemName: "بحص خشن", quantity: 200}
                        ],
                        totalQuantity: 200,
                        factory: "محطة 1",
                        notes: "إنتاج يومي عادي",
                        createdBy: 1,
                        financialYear: currentFinancialYear
                    }
                ];
                saveData('production', defaultProduction);
            }
            
            // تهيئة المدفوعات
            if (!loadData('payments').length) {
                const today = new Date().toISOString().split('T')[0];
                const defaultPayments = [
                    {
                        id: 1,
                        invoiceId: 1,
                        invoiceNo: "INV-2024-001",
                        date: today,
                        amount: 14375,
                        paymentMethod: "تحويل بنكي",
                        notes: "دفعة كاملة",
                        createdBy: 1,
                        financialYear: currentFinancialYear
                    }
                ];
                saveData('payments', defaultPayments);
            }
        }
        
        // ========== واجهة المستخدم ==========
        function updateCompanyUI() {
            document.getElementById('loginCompanyName').textContent = companyInfo.name;
            document.getElementById('appCompanyName').textContent = companyInfo.name;
            
            // تحديث الشعار
            if (companyInfo.logo) {
                document.getElementById('loginCompanyLogo').src = companyInfo.logo;
                document.getElementById('loginCompanyLogo').style.display = 'block';
                document.getElementById('loginLogoPlaceholder').style.display = 'none';
                
                document.getElementById('topLogoImg').src = companyInfo.logo;
                document.getElementById('topLogoImg').style.display = 'block';
                document.getElementById('topLogoIcon').style.display = 'none';
            } else {
                document.getElementById('loginCompanyLogo').style.display = 'none';
                document.getElementById('loginLogoPlaceholder').style.display = 'flex';
                
                document.getElementById('topLogoImg').style.display = 'none';
                document.getElementById('topLogoIcon').style.display = 'flex';
            }
        }
        
        function updateFinancialYearUI() {
            const currentYear = financialYears.find(y => y.status === 'open');
            if (currentYear) {
                document.getElementById('currentYear').textContent = currentYear.year;
                document.getElementById('yearStatusBadge').textContent = 'مفتوحة';
                document.getElementById('yearStatusBadge').className = 'year-status open';
            }
        }
        
        // ========== نظام تسجيل الدخول ==========
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showNotification('يرجى إدخال اسم المستخدم وكلمة المرور', 'error');
                return;
            }
            
            const users = loadData('users');
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                
                document.getElementById('currentUserName').textContent = user.name;
                document.getElementById('currentUserRole').textContent = user.role === 'admin' ? 'مدير النظام' : 'مستخدم';
                document.getElementById('userAvatar').textContent = user.avatar;
                
                showPage('dashboard');
                showNotification(`مرحباً ${user.name}`, 'success');
            } else {
                showNotification('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
            }
        }
        
        function toggleCredentials() {
            const testCredentialsDiv = document.getElementById('testCredentials');
            if (testCredentialsDiv.style.display === 'none') {
                testCredentialsDiv.style.display = 'block';
            } else {
                testCredentialsDiv.style.display = 'none';
            }
        }
        
        function logout() {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                currentUser = null;
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        }
        
        // ========== تغيير كلمة المرور ==========
        function showChangePassword() {
            document.getElementById('changePasswordModal').style.display = 'flex';
        }
        
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentUser) return;
            
            if (currentUser.password !== currentPassword) {
                showNotification('كلمة المرور الحالية غير صحيحة', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('كلمات المرور غير متطابقة', 'error');
                return;
            }
            
            let users = loadData('users');
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                saveData('users', users);
                currentUser = users[userIndex];
                
                closeModal('changePasswordModal');
                showNotification('تم تغيير كلمة المرور بنجاح', 'success');
            }
        }
        
        // ========== إدارة الصفحات ==========
        function showPage(page) {
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => item.classList.remove('active'));
            
            let clickedItem = event.target;
            while (clickedItem && !clickedItem.classList.contains('menu-item')) {
                clickedItem = clickedItem.parentElement;
            }
            if (clickedItem) clickedItem.classList.add('active');
            
            const contentArea = document.getElementById('contentArea');
            
            switch(page) {
                case 'dashboard':
                    contentArea.innerHTML = loadDashboard();
                    loadDashboardData();
                    break;
                case 'items':
                    contentArea.innerHTML = loadItemsPage();
                    loadItemsData();
                    break;
                case 'openingInventory':
                    contentArea.innerHTML = loadOpeningInventoryPage();
                    loadOpeningInventoryData();
                    break;
                case 'customers':
                    contentArea.innerHTML = loadCustomersPage();
                    loadCustomersData();
                    break;
                case 'production':
                    contentArea.innerHTML = loadProductionPage();
                    loadProductionData();
                    break;
                case 'salesOrders':
                    contentArea.innerHTML = loadSalesOrdersPage();
                    loadSalesOrdersData();
                    break;
                case 'sales':
                    contentArea.innerHTML = loadSalesPage();
                    loadSalesData();
                    break;
                case 'expenses':
                    contentArea.innerHTML = loadExpensesPage();
                    loadExpensesData();
                    break;
                case 'costCalculation':
                    contentArea.innerHTML = loadCostCalculationPage();
                    loadCostCalculationData();
                    break;
                case 'reports':
                    contentArea.innerHTML = loadReportsPage();
                    loadReportsData();
                    break;
                case 'payments':
                    contentArea.innerHTML = loadPaymentsPage();
                    loadPaymentsData();
                    break;
                case 'financialYears':
                    contentArea.innerHTML = loadFinancialYearsPage();
                    loadFinancialYearsData();
                    break;
                case 'users':
                    contentArea.innerHTML = loadUsersPage();
                    loadUsersData();
                    break;
                case 'settings':
                    contentArea.innerHTML = loadSettingsPage();
                    loadSettingsData();
                    break;
            }
        }
        
        // ========== صفحة الرئيسية ==========
        function loadDashboard() {
            return `
                <div class="page-header">
                    <h2><i class="fas fa-home"></i> لوحة التحكم الرئيسية</h2>
                    <div style="font-size: 14px;">آخر تحديث: ${new Date().toLocaleDateString('ar-SA')}</div>
                </div>
                
                <div class="stats-cards">
                    <div class="stat-card">
                        <i class="fas fa-boxes"></i>
                        <div class="stat-label">إجمالي المخزون</div>
                        <div class="stat-value" id="totalStock">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-shopping-cart"></i>
                        <div class="stat-label">المبيعات اليوم</div>
                        <div class="stat-value" id="todaySales">0 ر.س</div>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-industry"></i>
                        <div class="stat-label">الإنتاج اليوم</div>
                        <div class="stat-value" id="todayProduction">0 طن</div>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <div class="stat-label">عدد العملاء</div>
                        <div class="stat-value" id="totalCustomers">0</div>
                    </div>
                </div>
                
                <div class="form-container">
                    <h3><i class="fas fa-chart-line"></i> الإحصائيات السريعة</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 10px;">
                                <div>الأوامر النشطة</div>
                                <div class="summary-value" id="activeOrders">0</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px;">
                                <div>إجمالي المبيعات</div>
                                <div class="summary-value" id="totalSales">0 ر.س</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="background: #fff3cd; padding: 15px; border-radius: 10px;">
                                <div>إجمالي الإنتاج</div>
                                <div class="summary-value" id="totalProduction">0 طن</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-container">
                    <h3><i class="fas fa-history"></i> آخر المبيعات</h3>
                    <div id="recentSalesTable">
                        <!-- سيتم تحميل البيانات -->
                    </div>
                </div>
            `;
        }
        
        function loadDashboardData() {
            const items = loadData('items');
            const totalStock = items.reduce((sum, item) => sum + (item.stock || 0), 0);
            document.getElementById('totalStock').textContent = totalStock.toLocaleString();
            
            const sales = loadData('sales').filter(s => s.financialYear === currentFinancialYear);
            const today = new Date().toISOString().split('T')[0];
            const todaySales = sales
                .filter(sale => sale.date === today && !sale.isReturn)
                .reduce((sum, sale) => sum + (sale.total || 0), 0);
            document.getElementById('todaySales').textContent = todaySales.toLocaleString() + ' ر.س';
            
            const production = loadData('production').filter(p => p.financialYear === currentFinancialYear);
            const todayProduction = production
                .filter(prod => prod.date === today)
                .reduce((sum, prod) => sum + (prod.totalQuantity || 0), 0);
            document.getElementById('todayProduction').textContent = todayProduction.toLocaleString() + ' طن';
            
            const customers = loadData('customers');
            document.getElementById('totalCustomers').textContent = customers.length;
            
            const salesOrders = loadData('salesOrders').filter(o => o.financialYear === currentFinancialYear);
            const activeOrders = salesOrders.filter(order => order.status === 'pending').length;
            document.getElementById('activeOrders').textContent = activeOrders;
            
            const totalSales = sales
                .filter(sale => !sale.isReturn)
                .reduce((sum, sale) => sum + (sale.total || 0), 0);
            document.getElementById('totalSales').textContent = totalSales.toLocaleString() + ' ر.س';
            
            const totalProduction = production.reduce((sum, prod) => sum + (prod.totalQuantity || 0), 0);
            document.getElementById('totalProduction').textContent = totalProduction.toLocaleString() + ' طن';
            
            // عرض آخر 5 مبيعات
            const recentSales = sales
                .filter(sale => !sale.isReturn)
                .slice(-5)
                .reverse();
            let recentSalesHTML = '';
            
            if (recentSales.length > 0) {
                recentSalesHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>العميل</th>
                                <th>المبلغ</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                recentSales.forEach(sale => {
                    const statusColor = sale.status === 'completed' ? '#27ae60' : 
                                      sale.status === 'pending' ? '#f39c12' : '#e74c3c';
                    recentSalesHTML += `
                        <tr>
                            <td>${sale.invoiceNo}</td>
                            <td>${sale.date}</td>
                            <td>${sale.customerName}</td>
                            <td>${sale.total.toLocaleString()} ر.س</td>
                            <td><span style="padding: 3px 10px; border-radius: 15px; background: ${statusColor}; color: white;">${sale.status === 'completed' ? 'مكتمل' : sale.status === 'pending' ? 'قيد الانتظار' : 'ملغي'}</span></td>
                            <td class="action-buttons">
                                <button class="btn" onclick="viewInvoice(${sale.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                recentSalesHTML += `</tbody></table>`;
            } else {
                recentSalesHTML = '<div class="data-empty"><i class="fas fa-shopping-cart"></i><p>لا توجد مبيعات مسجلة</p></div>';
            }
            
            document.getElementById('recentSalesTable').innerHTML = recentSalesHTML;
        }
        
        // ========== صفحة الأصناف ==========
        function loadItemsPage() {
            return `
                <div class="page-header">
                    <h2><i class="fas fa-boxes"></i> إدارة الأصناف</h2>
                    <button class="btn" onclick="showItemForm()">
                        <i class="fas fa-plus"></i> إضافة صنف جديد
                    </button>
                </div>
                
                <div class="form-container" id="itemForm" style="display: none;">
                    <h3><i class="fas fa-plus-circle"></i> ${currentItemId ? 'تعديل صنف' : 'إضافة صنف جديد'}</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>كود الصنف:</label>
                            <input type="text" id="itemCode" placeholder="كود الصنف">
                        </div>
                        <div class="form-group">
                            <label>اسم الصنف:</label>
                            <input type="text" id="itemName" placeholder="اسم الصنف">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>الوحدة:</label>
                            <select id="itemUnit">
                                <option value="طن">طن</option>
                                <option value="كيلو">كيلو</option>
                                <option value="متر مكعب">متر مكعب</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>سعر البيع:</label>
                            <input type="number" id="itemPrice" placeholder="سعر البيع" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>سعر التكلفة:</label>
                            <input type="number" id="itemCost" placeholder="سعر التكلفة" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>الحد الأدنى للتنبيه:</label>
                            <input type="number" id="itemMinStock" placeholder="الحد الأدنى" step="0.01">
                        </div>
                    </div>
                    <button class="btn" onclick="saveItem()">
                        <i class="fas fa-save"></i> ${currentItemId ? 'تحديث' : 'حفظ'}
                    </button>
                    <button class="btn btn-secondary" onclick="hideItemForm()" style="margin-right: 10px;">
                        إلغاء
                    </button>
                </div>
                
                <div class="filter-container">
                    <div class="form-group" style="margin-bottom: 0;">
                        <input type="text" id="itemSearch" placeholder="البحث باسم أو كود الصنف..." onkeyup="searchItems()" style="padding: 10px;">
                    </div>
                </div>
                
                <div id="itemsTableContainer">
                    <!-- سيتم تحميل البيانات -->
                </div>
            `;
        }
        
        let currentItemId = null;
        
        function loadItemsData() {
            const items = loadData('items');
            let itemsTableHTML = '';
            
            if (items.length > 0) {
                itemsTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>الكود</th>
                                <th>اسم الصنف</th>
                                <th>الوحدة</th>
                                <th>المخزون</th>
                                <th>سعر البيع</th>
                                <th>سعر التكلفة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                items.forEach(item => {
                    const stockClass = item.stock < (item.minStock || 0) ? 'loss' : 'profit';
                    itemsTableHTML += `
                        <tr>
                            <td>${item.code}</td>
                            <td>${item.name}</td>
                            <td>${item.unit}</td>
                            <td class="${stockClass}">${item.stock.toLocaleString()}</td>
                            <td>${item.price.toLocaleString()} ر.س</td>
                            <td>${item.cost.toLocaleString()} ر.س</td>
                            <td class="action-buttons">
                                <button class="btn" onclick="editItem(${item.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteItem(${item.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                itemsTableHTML += `</tbody></table>`;
            } else {
                itemsTableHTML = '<div class="data-empty"><i class="fas fa-boxes"></i><p>لا توجد أصناف مسجلة</p></div>';
            }
            
            document.getElementById('itemsTableContainer').innerHTML = itemsTableHTML;
        }
        
        function showItemForm() {
            document.getElementById('itemForm').style.display = 'block';
        }
        
        function hideItemForm() {
            document.getElementById('itemForm').style.display = 'none';
            currentItemId = null;
            resetItemForm();
        }
        
        function resetItemForm() {
            document.getElementById('itemCode').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemUnit').value = 'طن';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemCost').value = '';
            document.getElementById('itemMinStock').value = '';
        }
        
        function saveItem() {
            const code = document.getElementById('itemCode').value.trim();
            const name = document.getElementById('itemName').value.trim();
            const price = parseFloat(document.getElementById('itemPrice').value) || 0;
            const cost = parseFloat(document.getElementById('itemCost').value) || 0;
            
            if (!code || !name || price <= 0 || cost <= 0) {
                showNotification('يرجى إدخال جميع البيانات بشكل صحيح', 'error');
                return;
            }
            
            const item = {
                id: currentItemId || Date.now(),
                code: code,
                name: name,
                unit: document.getElementById('itemUnit').value,
                price: price,
                cost: cost,
                stock: 0,
                openingStock: 0,
                minStock: parseFloat(document.getElementById('itemMinStock').value) || 0
            };
            
            let items = loadData('items');
            
            if (currentItemId) {
                const index = items.findIndex(i => i.id === currentItemId);
                if (index !== -1) {
                    item.stock = items[index].stock || 0;
                    item.openingStock = items[index].openingStock || 0;
                    items[index] = item;
                }
            } else {
                items.push(item);
            }
            
            saveData('items', items);
            hideItemForm();
            loadItemsData();
            showNotification(currentItemId ? 'تم تعديل الصنف' : 'تم إضافة الصنف بنجاح', 'success');
        }
        
        function editItem(id) {
            const items = loadData('items');
            const item = items.find(i => i.id === id);
            
            if (item) {
                currentItemId = id;
                document.getElementById('itemCode').value = item.code;
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemUnit').value = item.unit;
                document.getElementById('itemPrice').value = item.price;
                document.getElementById('itemCost').value = item.cost;
                document.getElementById('itemMinStock').value = item.minStock || '';
                showItemForm();
            }
        }
        
        function deleteItem(id) {
            if (confirm('هل تريد حذف هذا الصنف؟')) {
                let items = loadData('items');
                items = items.filter(i => i.id !== id);
                saveData('items', items);
                loadItemsData();
                showNotification('تم حذف الصنف', 'success');
            }
        }
        
        function searchItems() {
            const searchTerm = document.getElementById('itemSearch').value.toLowerCase();
            const items = loadData('items');
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(searchTerm) || 
                item.code.toLowerCase().includes(searchTerm)
            );
            
            let itemsTableHTML = '';
            
            if (filteredItems.length > 0) {
                itemsTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>الكود</th>
                                <th>اسم الصنف</th>
                                <th>الوحدة</th>
                                <th>المخزون</th>
                                <th>سعر البيع</th>
                                <th>سعر التكلفة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                filteredItems.forEach(item => {
                    const stockClass = item.stock < (item.minStock || 0) ? 'loss' : 'profit';
                    itemsTableHTML += `
                        <tr>
                            <td>${item.code}</td>
                            <td>${item.name}</td>
                            <td>${item.unit}</td>
                            <td class="${stockClass}">${item.stock.toLocaleString()}</td>
                            <td>${item.price.toLocaleString()} ر.س</td>
                            <td>${item.cost.toLocaleString()} ر.س</td>
                            <td class="action-buttons">
                                <button class="btn" onclick="editItem(${item.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteItem(${item.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                itemsTableHTML += `</tbody></table>`;
            } else {
                itemsTableHTML = '<div class="data-empty"><i class="fas fa-search"></i><p>لا توجد نتائج للبحث</p></div>';
            }
            
            document.getElementById('itemsTableContainer').innerHTML = itemsTableHTML;
        }
        
        // ========== صفحة المخزون الافتتاحي ==========
        function loadOpeningInventoryPage() {
            return `
                <div class="page-header">
                    <h2><i class="fas fa-box-open"></i> المخزون الافتتاحي</h2>
                </div>
                
                <div class="form-container">
                    <h3><i class="fas fa-calculator"></i> تسجيل المخزون الافتتاحي</h3>
                    <div class="warning-box">
                        <p><i class="fas fa-exclamation-triangle"></i> <strong>ملاحظة:</strong> المخزون الافتتاحي يتم تسجيله مرة واحدة عند بداية السنة المالية. سيتم استخدام هذه القيمة كأساس لحسابات المخزون.</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكود</th>
                                <th>المخزون الحالي</th>
                                <th>المخزون الافتتاحي</th>
                                <th>تحديد المخزون الافتتاحي</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="openingInventoryTable">
                            <!-- سيتم تحميل البيانات هنا -->
                        </tbody>
                    </table>
                    
                    <button class="btn btn-success" onclick="saveOpeningInventory()" style="margin-top: 20px;">
                        <i class="fas fa-save"></i> حفظ المخزون الافتتاحي
                    </button>
                </div>
            `;
        }
        
        function loadOpeningInventoryData() {
            const items = loadData('items');
            let tableHTML = '';
            
            items.forEach(item => {
                tableHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.code}</td>
                        <td>${item.stock.toLocaleString()}</td>
                        <td>${item.openingStock.toLocaleString()}</td>
                        <td>
                            <input type="number" id="openingStock_${item.id}" value="${item.openingStock}" 
                                   min="0" step="0.01" style="width: 100px; padding: 5px;">
                        </td>
                        <td>
                            <button class="btn" onclick="updateItemStock(${item.id})" style="padding: 5px 10px;">
                                <i class="fas fa-sync-alt"></i> تحديث
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('openingInventoryTable').innerHTML = tableHTML;
        }
        
        function updateItemStock(itemId) {
            const newStock = parseFloat(document.getElementById(`openingStock_${itemId}`).value) || 0;
            
            if (newStock < 0) {
                showNotification('لا يمكن أن تكون كمية المخزون سالبة', 'error');
                return;
            }
            
            let items = loadData('items');
            const itemIndex = items.findIndex(i => i.id === itemId);
            
            if (itemIndex !== -1) {
                items[itemIndex].openingStock = newStock;
                saveData('items', items);
                showNotification('تم تحديث المخزون الافتتاحي', 'success');
                loadOpeningInventoryData();
            }
        }
        
        function saveOpeningInventory() {
            showNotification('تم حفظ المخزون الافتتاحي بنجاح', 'success');
        }
        
        // ========== صفحة العملاء ==========
        function loadCustomersPage() {
            return `
                <div class="page-header">
                    <h2><i class="fas fa-users"></i> إدارة العملاء</h2>
                    <button class="btn" onclick="showCustomerForm()">
                        <i class="fas fa-plus"></i> إضافة عميل جديد
                    </button>
                </div>
                
                <div class="form-container" id="customerForm" style="display: none;">
                    <h3><i class="fas fa-plus-circle"></i> ${currentCustomerId ? 'تعديل عميل' : 'إضافة عميل جديد'}</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>كود العميل:</label>
                            <input type="text" id="customerCode" placeholder="كود العميل">
                        </div>
                        <div class="form-group">
                            <label>اسم العميل:</label>
                            <input type="text" id="customerName" placeholder="اسم العميل">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>الهاتف:</label>
                            <input type="tel" id="customerPhone" placeholder="رقم الهاتف">
                        </div>
                        <div class="form-group">
                            <label>البريد الإلكتروني:</label>
                            <input type="email" id="customerEmail" placeholder="البريد الإلكتروني">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>الرقم الضريبي:</label>
                            <input type="text" id="customerTaxNumber" placeholder="الرقم الضريبي">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>العنوان:</label>
                        <textarea id="customerAddress" rows="2" placeholder="عنوان العميل"></textarea>
                    </div>
                    <button class="btn" onclick="saveCustomer()">
                        <i class="fas fa-save"></i> ${currentCustomerId ? 'تحديث' : 'حفظ'}
                    </button>
                    <button class="btn btn-secondary" onclick="hideCustomerForm()" style="margin-right: 10px;">
                        إلغاء
                    </button>
                </div>
                
                <div class="filter-container">
                    <div class="form-group" style="margin-bottom: 0;">
                        <input type="text" id="customerSearch" placeholder="البحث باسم أو كود العميل..." onkeyup="searchCustomers()" style="padding: 10px;">
                    </div>
                </div>
                
                <div id="customersTableContainer">
                    <!-- سيتم تحميل البيانات -->
                </div>
            `;
        }
        
        let currentCustomerId = null;
        
        function loadCustomersData() {
            const customers = loadData('customers');
            let customersTableHTML = '';
            
            if (customers.length > 0) {
                customersTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>الكود</th>
                                <th>اسم العميل</th>
                                <th>الهاتف</th>
                                <th>الرقم الضريبي</th>
                                <th>الرصيد</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                customers.forEach(customer => {
                    customersTableHTML += `
                        <tr>
                            <td>${customer.code}</td>
                            <td>${customer.name}</td>
                            <td>${customer.phone || '-'}</td>
                            <td>${customer.taxNumber || '-'}</td>
                            <td>${(customer.balance || 0).toLocaleString()} ر.س</td>
                            <td class="action-buttons">
                                <button class="btn" onclick="editCustomer(${customer.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteCustomer(${customer.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                customersTableHTML += `</tbody></table>`;
            } else {
                customersTableHTML = '<div class="data-empty"><i class="fas fa-users"></i><p>لا توجد عملاء مسجلين</p></div>';
            }
            
            document.getElementById('customersTableContainer').innerHTML = customersTableHTML;
        }
        
        function showCustomerForm() {
            document.getElementById('customerForm').style.display = 'block';
        }
        
        function hideCustomerForm() {
            document.getElementById('customerForm').style.display = 'none';
            currentCustomerId = null;
            resetCustomerForm();
        }
        
        function resetCustomerForm() {
            document.getElementById('customerCode').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerTaxNumber').value = '';
            document.getElementById('customerAddress').value = '';
        }
        
        function saveCustomer() {
            const code = document.getElementById('customerCode').value.trim();
            const name = document.getElementById('customerName').value.trim();
            
            if (!code || !name) {
                showNotification('يرجى إدخال كود واسم العميل', 'error');
                return;
            }
            
            const customer = {
                id: currentCustomerId || Date.now(),
                code: code,
                name: name,
                phone: document.getElementById('customerPhone').value.trim(),
                email: document.getElementById('customerEmail').value.trim(),
                taxNumber: document.getElementById('customerTaxNumber').value.trim(),
                address: document.getElementById('customerAddress').value.trim(),
                balance: 0
            };
            
            let customers = loadData('customers');
            
            if (currentCustomerId) {
                const index = customers.findIndex(c => c.id === currentCustomerId);
                if (index !== -1) {
                    customer.balance = customers[index].balance || 0;
                    customers[index] = customer;
                }
            } else {
                customers.push(customer);
            }
            
            saveData('customers', customers);
            hideCustomerForm();
            loadCustomersData();
            showNotification(currentCustomerId ? 'تم تعديل العميل' : 'تم إضافة العميل بنجاح', 'success');
        }
        
        function editCustomer(id) {
            const customers = loadData('customers');
            const customer = customers.find(c => c.id === id);
            
            if (customer) {
                currentCustomerId = id;
                document.getElementById('customerCode').value = customer.code;
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerPhone').value = customer.phone || '';
                document.getElementById('customerEmail').value = customer.email || '';
                document.getElementById('customerTaxNumber').value = customer.taxNumber || '';
                document.getElementById('customerAddress').value = customer.address || '';
                showCustomerForm();
            }
        }
        
        function deleteCustomer(id) {
            if (confirm('هل تريد حذف هذا العميل؟')) {
                let customers = loadData('customers');
                customers = customers.filter(c => c.id !== id);
                saveData('customers', customers);
                loadCustomersData();
                showNotification('تم حذف العميل', 'success');
            }
        }
        
        function searchCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const customers = loadData('customers');
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) || 
                customer.code.toLowerCase().includes(searchTerm)
            );
            
            let customersTableHTML = '';
            
            if (filteredCustomers.length > 0) {
                customersTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>الكود</th>
                                <th>اسم العميل</th>
                                <th>الهاتف</th>
                                <th>الرقم الضريبي</th>
                                <th>الرصيد</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                filteredCustomers.forEach(customer => {
                    customersTableHTML += `
                        <tr>
                            <td>${customer.code}</td>
                            <td>${customer.name}</td>
                            <td>${customer.phone || '-'}</td>
                            <td>${customer.taxNumber || '-'}</td>
                            <td>${(customer.balance || 0).toLocaleString()} ر.س</td>
                            <td class="action-buttons">
                                <button class="btn" onclick="editCustomer(${customer.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteCustomer(${customer.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                customersTableHTML += `</tbody></table>`;
            } else {
                customersTableHTML = '<div class="data-empty"><i class="fas fa-search"></i><p>لا توجد نتائج للبحث</p></div>';
            }
            
            document.getElementById('customersTableContainer').innerHTML = customersTableHTML;
        }
        
        // ========== صفحة الإنتاج اليومي ==========
        function loadProductionPage() {
            return `
                <div class="page-header">
                    <h2><i class="fas fa-industry"></i> الإنتاج اليومي</h2>
                    <button class="btn" onclick="showProductionForm()">
                        <i class="fas fa-plus-circle"></i> تسجيل إنتاج جديد
                    </button>
                </div>
                
                <div class="form-container" id="productionForm" style="display: none;">
                    <h3><i class="fas fa-industry"></i> ${currentProductionId ? 'تعديل إنتاج' : 'تسجيل إنتاج جديد'}</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>تاريخ الإنتاج:</label>
                            <input type="date" id="productionDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>محطة الإنتاج:</label>
                            <select id="productionFactory">
                                <option value="محطة 1">محطة الإنتاج 1</option>
                                <option value="محطة 2">محطة الإنتاج 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="production-items-container">
                        <h4><i class="fas fa-list"></i> أصناف الإنتاج</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <select id="productionItem">
                                    <option value="">اختر الصنف</option>
                                    ${loadData('items').map(item => `
                                        <option value="${item.id}">${item.code} - ${item.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="number" id="productionQuantity" placeholder="الكمية بالطن" step="0.01">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn" onclick="addProductionItem()">
                                    <i class="fas fa-plus"></i> إضافة
                                </button>
                            </div>
                        </div>
                        
                        <div id="productionItemsList">
                            <!-- سيتم إضافة الأصناف هنا -->
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                            <strong>إجمالي الكمية:</strong> <span id="totalProductionQuantity">0</span> طن
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ملاحظات:</label>
                        <textarea id="productionNotes" rows="2" placeholder="ملاحظات عن عملية الإنتاج"></textarea>
                    </div>
                    <button class="btn" onclick="saveProduction()">
                        <i class="fas fa-save"></i> ${currentProductionId ? 'تحديث' : 'حفظ'}
                    </button>
                    <button class="btn btn-secondary" onclick="hideProductionForm()" style="margin-right: 10px;">
                        إلغاء
                    </button>
                </div>
                
                <div class="filter-container">
                    <div class="filter-row">
                        <div class="form-group">
                            <label>من تاريخ:</label>
                            <input type="date" id="productionFromDate">
                        </div>
                        <div class="form-group">
                            <label>إلى تاريخ:</label>
                            <input type="date" id="productionToDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>الصنف:</label>
                            <select id="productionItemFilter">
                                <option value="">جميع الأصناف</option>
                                ${loadData('items').map(item => `
                                    <option value="${item.id}">${item.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="filterProduction()">
                                <i class="fas fa-filter"></i> تصفية
                            </button>
                            <button class="btn btn-secondary" onclick="resetProductionFilter()" style="margin-right: 10px;">
                                <i class="fas fa-redo"></i> إعادة تعيين
                            </button>
                            <button class="btn btn-info" onclick="printProductionReport()" style="margin-right: 10px;">
                                <i class="fas fa-print"></i> طباعة تقرير
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="productionTableContainer">
                    <!-- سيتم تحميل البيانات -->
                </div>
            `;
        }
        
        let currentProductionId = null;
        let productionItems = [];
        
        function loadProductionData() {
            const productions = loadData('production').filter(p => p.financialYear === currentFinancialYear);
            let productionTableHTML = '';
            
            if (productions.length > 0) {
                productionTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>الأصناف</th>
                                <th>الكمية</th>
                                <th>المحطة</th>
                                <th>ملاحظات</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                productions.reverse().forEach(prod => {
                    const itemsList = prod.items.map(item => `${item.itemName} (${item.quantity} طن)`).join('<br>');
                    productionTableHTML += `
                        <tr>
                            <td>${prod.date}</td>
                            <td>${itemsList}</td>
                            <td>${prod.totalQuantity.toLocaleString()} طن</td>
                            <td><span style="padding: 3px 10px; border-radius: 5px; background: ${prod.factory === 'محطة 1' ? '#e3f2fd' : '#f3e5f5'}; color: ${prod.factory === 'محطة 1' ? '#1565c0' : '#7b1fa2'};">${prod.factory}</span></td>
                            <td>${prod.notes || '-'}</td>
                            <td class="action-buttons">
                                <button class="btn" onclick="editProduction(${prod.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-info" onclick="printProductionDocument(${prod.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteProduction(${prod.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                productionTableHTML += `</tbody></table>`;
            } else {
                productionTableHTML = '<div class="data-empty"><i class="fas fa-industry"></i><p>لا توجد عمليات إنتاج مسجلة</p></div>';
            }
            
            document.getElementById('productionTableContainer').innerHTML = productionTableHTML;
        }
        
        function showProductionForm() {
            productionItems = [];
            currentProductionId = null;
            document.getElementById('productionForm').style.display = 'block';
            updateProductionItemsList();
        }
        
        function hideProductionForm() {
            document.getElementById('productionForm').style.display = 'none';
            currentProductionId = null;
            productionItems = [];
            resetProductionForm();
        }
        
        function resetProductionForm() {
            document.getElementById('productionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('productionFactory').value = 'محطة 1';
            document.getElementById('productionItem').value = '';
            document.getElementById('productionQuantity').value = '';
            document.getElementById('productionNotes').value = '';
            productionItems = [];
            updateProductionItemsList();
        }
        
        function addProductionItem() {
            const itemId = parseInt(document.getElementById('productionItem').value);
            const quantity = parseFloat(document.getElementById('productionQuantity').value) || 0;
            
            if (!itemId || quantity <= 0) {
                showNotification('يرجى اختيار صنف وإدخال كمية صحيحة', 'error');
                return;
            }
            
            const items = loadData('items');
            const item = items.find(i => i.id === itemId);
            
            if (!item) {
                showNotification('الصنف غير موجود', 'error');
                return;
            }
            
            const productionItem = {
                itemId: itemId,
                itemName: item.name,
                quantity: quantity
            };
            
            productionItems.push(productionItem);
            
            document.getElementById('productionItem').value = '';
            document.getElementById('productionQuantity').value = '';
            
            updateProductionItemsList();
        }
        
        function updateProductionItemsList() {
            const container = document.getElementById('productionItemsList');
            container.innerHTML = '';
            
            let totalQuantity = 0;
            
            productionItems.forEach((item, index) => {
                totalQuantity += item.quantity;
                
                const itemRow = document.createElement('div');
                itemRow.className = 'production-item-row';
                itemRow.innerHTML = `
                    <div>
                        <strong>${item.itemName}</strong>
                    </div>
                    <div>
                        <input type="number" value="${item.quantity}" onchange="updateProductionItemQuantity(${index}, this.value)" step="0.01" style="width: 100%; padding: 5px;">
                    </div>
                    <div>
                        <span>طن</span>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="removeProductionItem(${index})" style="padding: 5px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(itemRow);
            });
            
            document.getElementById('totalProductionQuantity').textContent = totalQuantity.toLocaleString();
        }
        
        function updateProductionItemQuantity(index, value) {
            const quantity = parseFloat(value) || 0;
            if (quantity > 0) {
                productionItems[index].quantity = quantity;
                updateProductionItemsList();
            }
        }
        
        function removeProductionItem(index) {
            productionItems.splice(index, 1);
            updateProductionItemsList();
        }
        
        function saveProduction() {
            if (productionItems.length === 0) {
                showNotification('يرجى إضافة أصناف للإنتاج', 'error');
                return;
            }
            
            const date = document.getElementById('productionDate').value;
            const factory = document.getElementById('productionFactory').value;
            const notes = document.getElementById('productionNotes').value.trim();
            const totalQuantity = productionItems.reduce((sum, item) => sum + item.quantity, 0);
            
            let items = loadData('items');
            let hasError = false;
            
            // التحقق من المخزون (إذا كان تعديل)
            if (currentProductionId) {
                const oldProduction = loadData('production').find(p => p.id === currentProductionId);
                if (oldProduction) {
                    // إرجاع الكميات القديمة للمخزون
                    oldProduction.items.forEach(oldItem => {
                        const itemIndex = items.findIndex(i => i.id === oldItem.itemId);
                        if (itemIndex !== -1) {
                            items[itemIndex].stock = items[itemIndex].stock + oldItem.quantity;
                        }
                    });
                }
            }
            
            // إضافة الكميات الجديدة للمخزون
            productionItems.forEach(prodItem => {
                const itemIndex = items.findIndex(i => i.id === prodItem.itemId);
                if (itemIndex !== -1) {
                    items[itemIndex].stock = items[itemIndex].stock + prodItem.quantity;
                }
            });
            
            const production = {
                id: currentProductionId || Date.now(),
                date: date,
                items: [...productionItems],
                totalQuantity: totalQuantity,
                factory: factory,
                notes: notes,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString(),
                financialYear: currentFinancialYear
            };
            
            let productions = loadData('production');
            
            if (currentProductionId) {
                const index = productions.findIndex(p => p.id === currentProductionId);
                if (index !== -1) {
                    productions[index] = production;
                }
            } else {
                productions.push(production);
            }
            
            saveData('items', items);
            saveData('production', productions);
            
            hideProductionForm();
            loadProductionData();
            showNotification(currentProductionId ? 'تم تعديل الإنتاج' : 'تم تسجيل الإنتاج بنجاح', 'success');
        }
        
        function editProduction(id) {
            const productions = loadData('production');
            const production = productions.find(p => p.id === id);
            
            if (production) {
                currentProductionId = id;
                productionItems = [...production.items];
                document.getElementById('productionDate').value = production.date;
                document.getElementById('productionFactory').value = production.factory;
                document.getElementById('productionNotes').value = production.notes || '';
                showProductionForm();
                updateProductionItemsList();
            }
        }
        
        function deleteProduction(id) {
            if (confirm('هل تريد حذف عملية الإنتاج هذه؟')) {
                let productions = loadData('production');
                const production = productions.find(p => p.id === id);
                
                if (production) {
                    let items = loadData('items');
                    
                    // إرجاع الكميات للمخزون
                    production.items.forEach(prodItem => {
                        const itemIndex = items.findIndex(i => i.id === prodItem.itemId);
                        if (itemIndex !== -1) {
                            items[itemIndex].stock = Math.max(0, items[itemIndex].stock - prodItem.quantity);
                        }
                    });
                    
                    saveData('items', items);
                    
                    productions = productions.filter(p => p.id !== id);
                    saveData('production', productions);
                    loadProductionData();
                    showNotification('تم حذف عملية الإنتاج', 'success');
                }
            }
        }
        
        function filterProduction() {
            const fromDate = document.getElementById('productionFromDate').value;
            const toDate = document.getElementById('productionToDate').value;
            const itemId = document.getElementById('productionItemFilter').value;
            
            let productions = loadData('production').filter(p => p.financialYear === currentFinancialYear);
            
            if (fromDate) {
                productions = productions.filter(p => p.date >= fromDate);
            }
            
            if (toDate) {
                productions = productions.filter(p => p.date <= toDate);
            }
            
            if (itemId) {
                productions = productions.filter(p => 
                    p.items.some(item => item.itemId == itemId)
                );
            }
            
            let productionTableHTML = '';
            
            if (productions.length > 0) {
                productionTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>الأصناف</th>
                                <th>الكمية</th>
                                <th>المحطة</th>
                                <th>ملاحظات</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                productions.reverse().forEach(prod => {
                    const itemsList = prod.items.map(item => `${item.itemName} (${item.quantity} طن)`).join('<br>');
                    productionTableHTML += `
                        <tr>
                            <td>${prod.date}</td>
                            <td>${itemsList}</td>
                            <td>${prod.totalQuantity.toLocaleString()} طن</td>
                            <td><span style="padding: 3px 10px; border-radius: 5px; background: ${prod.factory === 'محطة 1' ? '#e3f2fd' : '#f3e5f5'}; color: ${prod.factory === 'محطة 1' ? '#1565c0' : '#7b1fa2'};">${prod.factory}</span></td>
                            <td>${prod.notes || '-'}</td>
                            <td class="action-buttons">
                                <button class="btn" onclick="editProduction(${prod.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-info" onclick="printProductionDocument(${prod.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteProduction(${prod.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                productionTableHTML += `</tbody></table>`;
            } else {
                productionTableHTML = '<div class="data-empty"><i class="fas fa-search"></i><p>لا توجد نتائج للبحث</p></div>';
            }
            
            document.getElementById('productionTableContainer').innerHTML = productionTableHTML;
        }
        
        function resetProductionFilter() {
            document.getElementById('productionFromDate').value = '';
            document.getElementById('productionToDate').value = '';
            document.getElementById('productionItemFilter').value = '';
            loadProductionData();
        }
        
        function printProductionDocument(id) {
            const productions = loadData('production');
            const production = productions.find(p => p.id === id);
            
            if (!production) return;
            
            let itemsHTML = '';
            production.items.forEach(item => {
                itemsHTML += `
                    <tr>
                        <td>${item.itemName}</td>
                        <td>${item.quantity} طن</td>
                    </tr>
                `;
            });
            
            let printHTML = `
                <div class="company-report-header">
                    ${companyInfo.logo ? `<img src="${companyInfo.logo}" class="report-logo" alt="شعار الشركة">` : '<h2>' + companyInfo.name + '</h2>'}
                    <p>${companyInfo.address}</p>
                    <p>هاتف: ${companyInfo.phone} | البريد: ${companyInfo.email}</p>
                    <hr>
                    <h3>سند إنتاج يومي</h3>
                    <p>رقم السند: ${production.id}</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <table>
                        <tr>
                            <td><strong>تاريخ الإنتاج:</strong></td>
                            <td>${production.date}</td>
                        </tr>
                        <tr>
                            <td><strong>محطة الإنتاج:</strong></td>
                            <td>${production.factory}</td>
                        </tr>
                        <tr>
                            <td><strong>إجمالي الكمية:</strong></td>
                            <td>${production.totalQuantity} طن</td>
                        </tr>
                        <tr>
                            <td><strong>ملاحظات:</strong></td>
                            <td>${production.notes || 'لا توجد ملاحظات'}</td>
                        </tr>
                    </table>
                </div>
                
                <h4>تفاصيل الأصناف المنتجة:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>الصنف</th>
                            <th>الكمية</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHTML}
                    </tbody>
                </table>
                
                <div class="signature-section">
                    <h4>التوقيعات:</h4>
                    <div class="signature-row">
                        <div class="signature-box">
                            <p>مشرف الإنتاج</p>
                            <div style="height: 50px; border-bottom: 1px solid #333;"></div>
                        </div>
                        <div class="signature-box">
                            <p>المحاسب</p>
                            <div style="height: 50px; border-bottom: 1px solid #333;"></div>
                        </div>
                        <div class="signature-box">
                            <p>مدير الكسارة</p>
                            <div style="height: 50px; border-bottom: 1px solid #333;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('printProductionContent').innerHTML = printHTML;
            document.getElementById('printProductionModal').style.display = 'flex';
        }
        
        function printProductionReport() {
            const fromDate = document.getElementById('productionFromDate').value;
            const toDate = document.getElementById('productionToDate').value;
            const itemId = document.getElementById('productionItemFilter').value;
            
            let productions = loadData('production').filter(p => p.financialYear === currentFinancialYear);
            
            if (fromDate) {
                productions = productions.filter(p => p.date >= fromDate);
            }
            
            if (toDate) {
                productions = productions.filter(p => p.date <= toDate);
            }
            
            if (itemId) {
                productions = productions.filter(p => 
                    p.items.some(item => item.itemId == itemId)
                );
            }
            
            let totalQuantity = productions.reduce((sum, prod) => sum + prod.totalQuantity, 0);
            
            let printHTML = `
                <div class="company-report-header">
                    ${companyInfo.logo ? `<img src="${companyInfo.logo}" class="report-logo" alt="شعار الشركة">` : '<h2>' + companyInfo.name + '</h2>'}
                    <p>${companyInfo.address}</p>
                    <p>هاتف: ${companyInfo.phone} | البريد: ${companyInfo.email}</p>
                    <hr>
                    <h3>تقرير الإنتاج</h3>
                    <p>من ${fromDate || 'البداية'} إلى ${toDate || new Date().toISOString().split('T')[0]}</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الأصناف</th>
                            <th>الكمية (طن)</th>
                            <th>المحطة</th>
                            <th>ملاحظات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            productions.forEach(prod => {
                const itemsList = prod.items.map(item => `${item.itemName} (${item.quantity} طن)`).join(', ');
                printHTML += `
                    <tr>
                        <td>${prod.date}</td>
                        <td>${itemsList}</td>
                        <td>${prod.totalQuantity.toLocaleString()}</td>
                        <td>${prod.factory}</td>
                        <td>${prod.notes || '-'}</td>
                    </tr>
                `;
            });
            
            printHTML += `
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <h4>الإجمالي: ${totalQuantity.toLocaleString()} طن</h4>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>طباعة تقرير الإنتاج</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
                        .company-report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #ddd; padding-bottom: 20px; }
                        .report-logo { max-width: 150px; max-height: 150px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #ddd; }
                        th { background: #f8f9fa; }
                    </style>
                </head>
                <body>
                    ${printHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // ========== صفحة أوامر البيع ==========
        function loadSalesOrdersPage() {
            return `
                <div class="page-header">
                    <h2><i class="fas fa-clipboard-list"></i> إدارة أوامر البيع</h2>
                    <button class="btn" onclick="showNewOrderForm()">
                        <i class="fas fa-plus-circle"></i> إنشاء أمر بيع جديد
                    </button>
                </div>
                
                <div class="form-container" id="newOrderForm" style="display: none;">
                    <h3><i class="fas fa-file-alt"></i> إنشاء أمر بيع جديد</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>رقم الأمر:</label>
                            <input type="text" id="orderNo" value="ORD-${new Date().getFullYear()}-${String(loadData('salesOrders').length + 1).padStart(3, '0')}" readonly>
                        </div>
                        <div class="form-group">
                            <label>تاريخ الأمر:</label>
                            <input type="date" id="orderDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>العميل:</label>
                            <select id="orderCustomer" onchange="updateCustomerInfoForOrder()">
                                <option value="">اختر العميل</option>
                                ${loadData('customers').map(customer => `
                                    <option value="${customer.id}">${customer.code} - ${customer.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>الضريبة:</label>
                            <input type="number" id="orderTaxRate" value="${companyInfo.taxRate || 15}" step="0.1" onchange="calculateOrderTotal()">%
                        </div>
                    </div>
                    
                    <div class="form-container" style="margin-top: 20px; background: #f8f9fa;">
                        <h4><i class="fas fa-list"></i> أصناف الأمر</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <select id="orderItemSelect" onchange="updateOrderItemPrice()">
                                    <option value="">اختر الصنف</option>
                                    ${loadData('items').map(item => `
                                        <option value="${item.id}">${item.code} - ${item.name} (المخزون: ${item.stock})</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="number" id="orderItemQuantity" placeholder="الكمية" step="0.01" onchange="calculateOrderItemTotal()">
                            </div>
                            <div class="form-group">
                                <input type="number" id="orderItemPrice" placeholder="السعر" step="0.01" onchange="calculateOrderItemTotal()">
                            </div>
                            <div class="form-group">
                                <input type="text" id="orderItemTotal" placeholder="الإجمالي" readonly style="background: #f8f9fa;">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn" onclick="addOrderItem()">
                                    <i class="fas fa-plus"></i> إضافة
                                </button>
                            </div>
                        </div>
                        
                        <table style="margin-top: 20px;">
                            <thead>
                                <tr>
                                    <th>الصنف</th>
                                    <th>الكمية</th>
                                    <th>السعر</th>
                                    <th>الإجمالي</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="orderItemsTable">
                                <!-- سيتم إضافة الأصناف هنا -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="form-row" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>الإجمالي:</label>
                            <input type="text" id="orderSubtotal" value="0" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label>الخصم:</label>
                            <input type="number" id="orderDiscount" value="0" step="0.01" onchange="calculateOrderTotal()">
                        </div>
                        <div class="form-group">
                            <label>الضريبة:</label>
                            <input type="text" id="orderTax" value="0" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label>المبلغ الإجمالي:</label>
                            <input type="text" id="orderTotal" value="0" readonly style="background: #e8f5e9; font-weight: bold;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ملاحظات:</label>
                        <textarea id="orderNotes" rows="2" placeholder="ملاحظات إضافية"></textarea>
                    </div>
                    
                    <button class="btn btn-success" onclick="saveOrder()">
                        <i class="fas fa-save"></i> حفظ الأمر
                    </button>
                    <button class="btn btn-info" onclick="saveOrderAndCreateInvoice()" style="margin-right: 10px;">
                        <i class="fas fa-file-invoice"></i> حفظ وإنشاء فاتورة
                    </button>
                    <button class="btn btn-secondary" onclick="hideNewOrderForm()" style="margin-right: 10px;">
                        إلغاء
                    </button>
                </div>
                
                <div class="filter-container">
                    <div class="filter-row">
                        <div class="form-group">
                            <label>من تاريخ:</label>
                            <input type="date" id="ordersFromDate">
                        </div>
                        <div class="form-group">
                            <label>إلى تاريخ:</label>
                            <input type="date" id="ordersToDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>حالة الأمر:</label>
                            <select id="ordersStatusFilter">
                                <option value="">جميع الحالات</option>
                                <option value="pending">قيد الانتظار</option>
                                <option value="confirmed">مؤكد</option>
                                <option value="cancelled">ملغي</option>
                                <option value="invoiced">تم الفوترة</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="filterOrders()">
                                <i class="fas fa-filter"></i> تصفية
                            </button>
                            <button class="btn btn-secondary" onclick="resetOrdersFilter()" style="margin-right: 10px;">
                                <i class="fas fa-redo"></i> إعادة تعيين
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="ordersTableContainer">
                    <!-- سيتم تحميل البيانات -->
                </div>
            `;
        }
        
        let orderItems = [];
        let currentOrderId = null;
        
        function loadSalesOrdersData() {
            const orders = loadData('salesOrders').filter(o => o.financialYear === currentFinancialYear);
            let ordersTableHTML = '';
            
            if (orders.length > 0) {
                ordersTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الأمر</th>
                                <th>التاريخ</th>
                                <th>العميل</th>
                                <th>المبلغ</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                orders.reverse().forEach(order => {
                    const statusColor = order.status === 'invoiced' ? '#27ae60' : 
                                     order.status === 'confirmed' ? '#3498db' : 
                                     order.status === 'cancelled' ? '#e74c3c' : '#f39c12';
                    const statusText = order.status === 'invoiced' ? 'تم الفوترة' : 
                                     order.status === 'confirmed' ? 'مؤكد' : 
                                     order.status === 'cancelled' ? 'ملغي' : 'قيد الانتظار';
                    
                    ordersTableHTML += `
                        <tr>
                            <td>${order.orderNo}</td>
                            <td>${order.date}</td>
                            <td>${order.customerName}</td>
                            <td>${order.total.toLocaleString()} ر.س</td>
                            <td><span style="padding: 3px 10px; border-radius: 15px; background: ${statusColor}; color: white;">${statusText}</span></td>
                            <td class="action-buttons">
                                <button class="btn" onclick="viewOrderDetails(${order.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-info" onclick="printOrderDocument(${order.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-print"></i>
                                </button>
                                ${order.status !== 'invoiced' ? `
                                    <button class="btn btn-success" onclick="createInvoiceFromOrder(${order.id})" style="padding: 5px 10px;">
                                        <i class="fas fa-file-invoice"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-danger" onclick="deleteOrder(${order.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                ordersTableHTML += `</tbody></table>`;
            } else {
                ordersTableHTML = '<div class="data-empty"><i class="fas fa-clipboard-list"></i><p>لا توجد أوامر بيع مسجلة</p></div>';
            }
            
            document.getElementById('ordersTableContainer').innerHTML = ordersTableHTML;
        }
        
        function showNewOrderForm() {
            orderItems = [];
            currentOrderId = null;
            document.getElementById('newOrderForm').style.display = 'block';
            updateOrderItemsTable();
        }
        
        function hideNewOrderForm() {
            document.getElementById('newOrderForm').style.display = 'none';
            resetOrderForm();
        }
        
        function resetOrderForm() {
            document.getElementById('orderNo').value = `ORD-${new Date().getFullYear()}-${String(loadData('salesOrders').length + 1).padStart(3, '0')}`;
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('orderCustomer').value = '';
            document.getElementById('orderTaxRate').value = companyInfo.taxRate || 15;
            document.getElementById('orderItemSelect').value = '';
            document.getElementById('orderItemQuantity').value = '';
            document.getElementById('orderItemPrice').value = '';
            document.getElementById('orderItemTotal').value = '';
            document.getElementById('orderSubtotal').value = '0';
            document.getElementById('orderDiscount').value = '0';
            document.getElementById('orderTax').value = '0';
            document.getElementById('orderTotal').value = '0';
            document.getElementById('orderNotes').value = '';
            orderItems = [];
            updateOrderItemsTable();
        }
        
        function updateCustomerInfoForOrder() {
            const customerId = parseInt(document.getElementById('orderCustomer').value);
            const customers = loadData('customers');
            const customer = customers.find(c => c.id === customerId);
            
            if (customer) {
                if (customer.taxNumber) {
                    document.getElementById('orderTaxRate').value = companyInfo.taxRate || 15;
                } else {
                    document.getElementById('orderTaxRate').value = 0;
                }
                calculateOrderTotal();
            }
        }
        
        function updateOrderItemPrice() {
            const itemId = parseInt(document.getElementById('orderItemSelect').value);
            const items = loadData('items');
            const item = items.find(i => i.id === itemId);
            
            if (item) {
                const exchangeRate = companyInfo.exchangeRate || 1;
                const adjustedPrice = item.price * exchangeRate;
                document.getElementById('orderItemPrice').value = adjustedPrice.toFixed(2);
                calculateOrderItemTotal();
            }
        }
        
        function calculateOrderItemTotal() {
            const quantity = parseFloat(document.getElementById('orderItemQuantity').value) || 0;
            const price = parseFloat(document.getElementById('orderItemPrice').value) || 0;
            const total = quantity * price;
            document.getElementById('orderItemTotal').value = total.toFixed(2);
        }
        
        function addOrderItem() {
            const itemId = parseInt(document.getElementById('orderItemSelect').value);
            const quantity = parseFloat(document.getElementById('orderItemQuantity').value) || 0;
            const price = parseFloat(document.getElementById('orderItemPrice').value) || 0;
            
            if (!itemId || quantity <= 0 || price <= 0) {
                showNotification('يرجى اختيار صنف وإدخال الكمية والسعر', 'error');
                return;
            }
            
            const items = loadData('items');
            const item = items.find(i => i.id === itemId);
            
            if (!item) {
                showNotification('الصنف غير موجود', 'error');
                return;
            }
            
            if (item.stock < quantity) {
                showNotification(`الكمية المطلوبة (${quantity}) أكبر من المخزون المتاح (${item.stock})`, 'error');
                return;
            }
            
            const orderItem = {
                itemId: itemId,
                itemName: item.name,
                quantity: quantity,
                price: price,
                total: quantity * price
            };
            
            orderItems.push(orderItem);
            
            document.getElementById('orderItemSelect').value = '';
            document.getElementById('orderItemQuantity').value = '';
            document.getElementById('orderItemPrice').value = '';
            document.getElementById('orderItemTotal').value = '';
            
            updateOrderItemsTable();
            calculateOrderTotal();
        }
        
        function updateOrderItemsTable() {
            const tbody = document.getElementById('orderItemsTable');
            tbody.innerHTML = '';
            
            orderItems.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.itemName}</td>
                    <td>${item.quantity}</td>
                    <td>${item.price.toLocaleString()} ر.س</td>
                    <td>${item.total.toLocaleString()} ر.س</td>
                    <td class="action-buttons">
                        <button class="btn btn-danger" onclick="removeOrderItem(${index})" style="padding: 5px 10px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        function removeOrderItem(index) {
            orderItems.splice(index, 1);
            updateOrderItemsTable();
            calculateOrderTotal();
        }
        
        function calculateOrderTotal() {
            const subtotal = orderItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('orderDiscount').value) || 0;
            const taxRate = parseFloat(document.getElementById('orderTaxRate').value) || 0;
            const taxableAmount = subtotal - discount;
            const tax = taxableAmount * (taxRate / 100);
            const total = taxableAmount + tax;
            
            document.getElementById('orderSubtotal').value = subtotal.toLocaleString();
            document.getElementById('orderTax').value = tax.toLocaleString();
            document.getElementById('orderTotal').value = total.toLocaleString();
        }
        
        function saveOrder() {
            const customerId = parseInt(document.getElementById('orderCustomer').value);
            const date = document.getElementById('orderDate').value;
            
            if (!customerId) {
                showNotification('يرجى اختيار العميل', 'error');
                return;
            }
            
            if (orderItems.length === 0) {
                showNotification('يرجى إضافة أصناف للأمر', 'error');
                return;
            }
            
            const customers = loadData('customers');
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) {
                showNotification('العميل غير موجود', 'error');
                return;
            }
            
            const subtotal = orderItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('orderDiscount').value) || 0;
            const taxRate = parseFloat(document.getElementById('orderTaxRate').value) || 0;
            const taxableAmount = subtotal - discount;
            const tax = taxableAmount * (taxRate / 100);
            const total = taxableAmount + tax;
            const notes = document.getElementById('orderNotes').value.trim();
            
            const order = {
                id: currentOrderId || Date.now(),
                orderNo: document.getElementById('orderNo').value,
                date: date,
                customerId: customerId,
                customerName: customer.name,
                items: [...orderItems],
                subtotal: subtotal,
                discount: discount,
                tax: tax,
                total: total,
                status: 'pending',
                notes: notes,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString(),
                financialYear: currentFinancialYear
            };
            
            let orders = loadData('salesOrders');
            
            if (currentOrderId) {
                const index = orders.findIndex(o => o.id === currentOrderId);
                if (index !== -1) {
                    orders[index] = order;
                }
            } else {
                orders.push(order);
            }
            
            saveData('salesOrders', orders);
            
            hideNewOrderForm();
            loadSalesOrdersData();
            showNotification(currentOrderId ? 'تم تعديل الأمر' : 'تم حفظ الأمر بنجاح', 'success');
        }
        
        function saveOrderAndCreateInvoice() {
            saveOrder();
            if (currentOrderId) {
                createInvoiceFromOrder(currentOrderId);
            }
        }
        
        function viewOrderDetails(id) {
            const orders = loadData('salesOrders');
            const order = orders.find(o => o.id === id);
            
            if (!order) return;
            
            let orderHTML = `
                <div class="form-container">
                    <h3><i class="fas fa-eye"></i> تفاصيل أمر البيع</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>رقم الأمر:</label>
                            <input type="text" value="${order.orderNo}" readonly>
                        </div>
                        <div class="form-group">
                            <label>تاريخ الأمر:</label>
                            <input type="text" value="${order.date}" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>العميل:</label>
                            <input type="text" value="${order.customerName}" readonly>
                        </div>
                        <div class="form-group">
                            <label>حالة الأمر:</label>
                            <input type="text" value="${order.status === 'invoiced' ? 'تم الفوترة' : order.status === 'confirmed' ? 'مؤكد' : order.status === 'cancelled' ? 'ملغي' : 'قيد الانتظار'}" readonly>
                        </div>
                    </div>
                    
                    <table style="margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            order.items.forEach(item => {
                orderHTML += `
                    <tr>
                        <td>${item.itemName}</td>
                        <td>${item.quantity}</td>
                        <td>${item.price.toLocaleString()} ر.س</td>
                        <td>${item.total.toLocaleString()} ر.س</td>
                    </tr>
                `;
            });
            
            orderHTML += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div>الإجمالي: ${order.subtotal.toLocaleString()} ر.س</div>
                        <div>الخصم: ${order.discount.toLocaleString()} ر.س</div>
                        <div>الضريبة: ${order.tax.toLocaleString()} ر.س</div>
                        <div style="font-weight: bold; font-size: 18px;">المبلغ الإجمالي: ${order.total.toLocaleString()} ر.س</div>
                    </div>
                    
                    ${order.notes ? `<div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px;"><strong>ملاحظات:</strong><br>${order.notes}</div>` : ''}
                    
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn" onclick="printOrderDocument(${order.id})">
                            <i class="fas fa-print"></i> طباعة الأمر
                        </button>
                        ${order.status !== 'invoiced' ? `
                            <button class="btn btn-success" onclick="createInvoiceFromOrder(${order.id})" style="margin-right: 10px;">
                                <i class="fas fa-file-invoice"></i> إنشاء فاتورة
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="showPage('salesOrders')" style="margin-right: 10px;">
                            رجوع
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = orderHTML;
        }
        
        function createInvoiceFromOrder(orderId) {
            const orders = loadData('salesOrders');
            const order = orders.find(o => o.id === orderId);
            
            if (!order) {
                showNotification('الطلب غير موجود', 'error');
                return;
            }
            
            if (order.status === 'invoiced') {
                showNotification('تم إنشاء فاتورة لهذا الأمر مسبقاً', 'warning');
                return;
            }
            
            if (confirm('هل تريد إنشاء فاتورة من هذا الأمر؟')) {
                const sale = {
                    id: Date.now(),
                    invoiceNo: `INV-${new Date().getFullYear()}-${String(loadData('sales').length + 1).padStart(3, '0')}`,
                    date: new Date().toISOString().split('T')[0],
                    customerId: order.customerId,
                    customerName: order.customerName,
                    items: [...order.items],
                    subtotal: order.subtotal,
                    discount: order.discount,
                    tax: order.tax,
                    total: order.total,
                    paid: 0,
                    balance: order.total,
                    status: 'pending',
                    notes: `فاتورة من أمر رقم: ${order.orderNo}\n${order.notes || ''}`,
                    createdBy: currentUser.id,
                    createdAt: new Date().toISOString(),
                    isReturn: false,
                    orderId: orderId,
                    financialYear: currentFinancialYear
                };
                
                let items = loadData('items');
                let hasStockIssue = false;
                
                for (const saleItem of sale.items) {
                    const itemIndex = items.findIndex(i => i.id === saleItem.itemId);
                    if (itemIndex !== -1) {
                        if (items[itemIndex].stock < saleItem.quantity) {
                            hasStockIssue = true;
                            showNotification(`الكمية المطلوبة من ${saleItem.itemName} (${saleItem.quantity}) أكبر من المخزون المتاح (${items[itemIndex].stock})`, 'error');
                            break;
                        }
                    }
                }
                
                if (hasStockIssue) return;
                
                for (const saleItem of sale.items) {
                    const itemIndex = items.findIndex(i => i.id === saleItem.itemId);
                    if (itemIndex !== -1) {
                        items[itemIndex].stock = items[itemIndex].stock - saleItem.quantity;
                    }
                }
                
                let sales = loadData('sales');
                sales.push(sale);
                
                const orderIndex = orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    orders[orderIndex].status = 'invoiced';
                }
                
                saveData('items', items);
                saveData('sales', sales);
                saveData('salesOrders', orders);
                
                showPage('sales');
                setTimeout(() => {
                    loadSalesData();
                    showNotification('تم إنشاء الفاتورة بنجاح', 'success');
                }, 100);
            }
        }
        
        function printOrderDocument(id) {
            const orders = loadData('salesOrders');
            const order = orders.find(o => o.id === id);
            
            if (!order) return;
            
            let printHTML = `
                <div class="company-report-header">
                    ${companyInfo.logo ? `<img src="${companyInfo.logo}" class="report-logo" alt="شعار الشركة">` : '<h2>' + companyInfo.name + '</h2>'}
                    <p>${companyInfo.address}</p>
                    <p>هاتف: ${companyInfo.phone} | البريد: ${companyInfo.email}</p>
                    <hr>
                    <h3>أمر بيع</h3>
                    <p>رقم الأمر: ${order.orderNo}</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <table>
                        <tr>
                            <td><strong>تاريخ الأمر:</strong></td>
                            <td>${order.date}</td>
                        </tr>
                        <tr>
                            <td><strong>العميل:</strong></td>
                            <td>${order.customerName}</td>
                        </tr>
                        <tr>
                            <td><strong>حالة الأمر:</strong></td>
                            <td>${order.status === 'invoiced' ? 'تم الفوترة' : order.status === 'confirmed' ? 'مؤكد' : order.status === 'cancelled' ? 'ملغي' : 'قيد الانتظار'}</td>
                        </tr>
                    </table>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>الصنف</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            order.items.forEach(item => {
                printHTML += `
                    <tr>
                        <td>${item.itemName}</td>
                        <td>${item.quantity}</td>
                        <td>${item.price.toLocaleString()} ر.س</td>
                        <td>${item.total.toLocaleString()} ر.س</td>
                    </tr>
                `;
            });
            
            printHTML += `
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <div>الإجمالي: ${order.subtotal.toLocaleString()} ر.س</div>
                    <div>الخصم: ${order.discount.toLocaleString()} ر.س</div>
                    <div>الضريبة: ${order.tax.toLocaleString()} ر.س</div>
                    <div style="font-weight: bold; font-size: 18px;">المبلغ الإجمالي: ${order.total.toLocaleString()} ر.س</div>
                </div>
                
                ${order.notes ? `<div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px;"><strong>ملاحظات:</strong><br>${order.notes}</div>` : ''}
                
                <div class="signature-section">
                    <h4>التوقيعات:</h4>
                    <div class="signature-row">
                        <div class="signature-box">
                            <p>مندوب المبيعات</p>
                            <div style="height: 50px; border-bottom: 1px solid #333;"></div>
                        </div>
                        <div class="signature-box">
                            <p>مدير المبيعات</p>
                            <div style="height: 50px; border-bottom: 1px solid #333;"></div>
                        </div>
                        <div class="signature-box">
                            <p>العميل</p>
                            <div style="height: 50px; border-bottom: 1px solid #333;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('printOrderContent').innerHTML = printHTML;
            document.getElementById('printOrderModal').style.display = 'flex';
        }
        
        function printOrderDocument() {
            const printContent = document.getElementById('printOrderContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>طباعة أمر البيع</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
                        .company-report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #ddd; padding-bottom: 20px; }
                        .report-logo { max-width: 150px; max-height: 150px; margin-bottom: 20px; }
                        .signature-section { margin-top: 50px; }
                        .signature-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
                        .signature-box { text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #ddd; }
                        th { background: #f8f9fa; }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        function deleteOrder(id) {
            if (confirm('هل تريد حذف هذا الأمر؟')) {
                let orders = loadData('salesOrders');
                orders = orders.filter(o => o.id !== id);
                saveData('salesOrders', orders);
                loadSalesOrdersData();
                showNotification('تم حذف الأمر', 'success');
            }
        }
        
        function filterOrders() {
            const fromDate = document.getElementById('ordersFromDate').value;
            const toDate = document.getElementById('ordersToDate').value;
            const status = document.getElementById('ordersStatusFilter').value;
            
            let orders = loadData('salesOrders').filter(o => o.financialYear === currentFinancialYear);
            
            if (fromDate) {
                orders = orders.filter(o => o.date >= fromDate);
            }
            
            if (toDate) {
                orders = orders.filter(o => o.date <= toDate);
            }
            
            if (status) {
                orders = orders.filter(o => o.status === status);
            }
            
            let ordersTableHTML = '';
            
            if (orders.length > 0) {
                ordersTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الأمر</th>
                                <th>التاريخ</th>
                                <th>العميل</th>
                                <th>المبلغ</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                orders.reverse().forEach(order => {
                    const statusColor = order.status === 'invoiced' ? '#27ae60' : 
                                     order.status === 'confirmed' ? '#3498db' : 
                                     order.status === 'cancelled' ? '#e74c3c' : '#f39c12';
                    const statusText = order.status === 'invoiced' ? 'تم الفوترة' : 
                                     order.status === 'confirmed' ? 'مؤكد' : 
                                     order.status === 'cancelled' ? 'ملغي' : 'قيد الانتظار';
                    
                    ordersTableHTML += `
                        <tr>
                            <td>${order.orderNo}</td>
                            <td>${order.date}</td>
                            <td>${order.customerName}</td>
                            <td>${order.total.toLocaleString()} ر.س</td>
                            <td><span style="padding: 3px 10px; border-radius: 15px; background: ${statusColor}; color: white;">${statusText}</span></td>
                            <td class="action-buttons">
                                <button class="btn" onclick="viewOrderDetails(${order.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-info" onclick="printOrderDocument(${order.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-print"></i>
                                </button>
                                ${order.status !== 'invoiced' ? `
                                    <button class="btn btn-success" onclick="createInvoiceFromOrder(${order.id})" style="padding: 5px 10px;">
                                        <i class="fas fa-file-invoice"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-danger" onclick="deleteOrder(${order.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                ordersTableHTML += `</tbody></table>`;
            } else {
                ordersTableHTML = '<div class="data-empty"><i class="fas fa-search"></i><p>لا توجد نتائج للبحث</p></div>';
            }
            
            document.getElementById('ordersTableContainer').innerHTML = ordersTableHTML;
        }
        
        function resetOrdersFilter() {
            document.getElementById('ordersFromDate').value = '';
            document.getElementById('ordersToDate').value = '';
            document.getElementById('ordersStatusFilter').value = '';
            loadSalesOrdersData();
        }
        
        // ========== صفحة المبيعات ==========
        function loadSalesPage() {
            return `
                <div class="page-header">
                    <h2><i class="fas fa-shopping-cart"></i> إدارة المبيعات</h2>
                    <button class="btn" onclick="showNewSaleForm()">
                        <i class="fas fa-plus-circle"></i> إضافة فاتورة بيع
                    </button>
                </div>
                
                <div class="form-container" id="newSaleForm" style="display: none;">
                    <h3><i class="fas fa-file-invoice"></i> إنشاء فاتورة بيع جديدة</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>رقم الفاتورة:</label>
                            <input type="text" id="invoiceNo" value="INV-${new Date().getFullYear()}-${String(loadData('sales').length + 1).padStart(3, '0')}" readonly>
                        </div>
                        <div class="form-group">
                            <label>تاريخ الفاتورة:</label>
                            <input type="date" id="saleDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>العميل:</label>
                            <select id="saleCustomer" onchange="updateCustomerTaxInfo()">
                                <option value="">اختر العميل</option>
                                ${loadData('customers').map(customer => `
                                    <option value="${customer.id}">${customer.code} - ${customer.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>الضريبة:</label>
                            <input type="number" id="saleTaxRate" value="${companyInfo.taxRate || 15}" step="0.1" onchange="calculateSaleTotal()">%
                        </div>
                    </div>
                    
                    <div class="form-container" style="margin-top: 20px; background: #f8f9fa;">
                        <h4><i class="fas fa-list"></i> أصناف الفاتورة</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <select id="saleItemSelect" onchange="updateSaleItemPrice()">
                                    <option value="">اختر الصنف</option>
                                    ${loadData('items').map(item => `
                                        <option value="${item.id}">${item.code} - ${item.name} (المخزون: ${item.stock})</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="number" id="saleItemQuantity" placeholder="الكمية" step="0.01" onchange="calculateSaleItemTotal()">
                            </div>
                            <div class="form-group">
                                <input type="number" id="saleItemPrice" placeholder="السعر" step="0.01" onchange="calculateSaleItemTotal()">
                            </div>
                            <div class="form-group">
                                <input type="text" id="saleItemTotal" placeholder="الإجمالي" readonly style="background: #f8f9fa;">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn" onclick="addSaleItem()">
                                    <i class="fas fa-plus"></i> إضافة
                                </button>
                            </div>
                        </div>
                        
                        <table style="margin-top: 20px;">
                            <thead>
                                <tr>
                                    <th>الصنف</th>
                                    <th>الكمية</th>
                                    <th>السعر</th>
                                    <th>الإجمالي</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="saleItemsTable">
                                <!-- سيتم إضافة الأصناف هنا -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="form-row" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>الإجمالي:</label>
                            <input type="text" id="saleSubtotal" value="0" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label>الخصم:</label>
                            <input type="number" id="saleDiscount" value="0" step="0.01" onchange="calculateSaleTotal()">
                        </div>
                        <div class="form-group">
                            <label>الضريبة:</label>
                            <input type="text" id="saleTax" value="0" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label>المبلغ الإجمالي:</label>
                            <input type="text" id="saleTotal" value="0" readonly style="background: #e8f5e9; font-weight: bold;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ملاحظات:</label>
                        <textarea id="saleNotes" rows="2" placeholder="ملاحظات إضافية"></textarea>
                    </div>
                    
                    <button class="btn btn-success" onclick="saveSale()">
                        <i class="fas fa-save"></i> حفظ الفاتورة
                    </button>
                    <button class="btn btn-secondary" onclick="hideNewSaleForm()" style="margin-right: 10px;">
                        إلغاء
                    </button>
                </div>
                
                <div class="filter-container">
                    <div class="filter-row">
                        <div class="form-group">
                            <label>من تاريخ:</label>
                            <input type="date" id="salesFromDate">
                        </div>
                        <div class="form-group">
                            <label>إلى تاريخ:</label>
                            <input type="date" id="salesToDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>حالة الفاتورة:</label>
                            <select id="salesStatusFilter">
                                <option value="">جميع الحالات</option>
                                <option value="completed">مكتمل</option>
                                <option value="pending">قيد الانتظار</option>
                                <option value="cancelled">ملغي</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>العميل:</label>
                            <select id="salesCustomerFilter">
                                <option value="">جميع العملاء</option>
                                ${loadData('customers').map(customer => `
                                    <option value="${customer.id}">${customer.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="filterSales()">
                                <i class="fas fa-filter"></i> تصفية
                            </button>
                            <button class="btn btn-secondary" onclick="resetSalesFilter()" style="margin-right: 10px;">
                                <i class="fas fa-redo"></i> إعادة تعيين
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="salesTableContainer">
                    <!-- سيتم تحميل البيانات -->
                </div>
            `;
        }
        
        let saleItems = [];
        let currentSaleId = null;
        
        function loadSalesData() {
            const sales = loadData('sales').filter(s => s.financialYear === currentFinancialYear);
            let salesTableHTML = '';
            
            if (sales.length > 0) {
                salesTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>العميل</th>
                                <th>الإجمالي</th>
                                <th>الضريبة</th>
                                <th>المجموع</th>
                                <th>الحالة</th>
                                <th>نوع</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                sales.reverse().forEach(sale => {
                    const statusColor = sale.status === 'completed' ? '#27ae60' : 
                                      sale.status === 'pending' ? '#f39c12' : '#e74c3c';
                    const statusText = sale.status === 'completed' ? 'مكتمل' : 
                                     sale.status === 'pending' ? 'قيد الانتظار' : 'ملغي';
                    const typeText = sale.isReturn ? '<span style="color: #e74c3c;">مرتجع</span>' : '<span style="color: #27ae60;">بيع</span>';
                    
                    salesTableHTML += `
                        <tr>
                            <td>${sale.invoiceNo}</td>
                            <td>${sale.date}</td>
                            <td>${sale.customerName}</td>
                            <td>${sale.subtotal.toLocaleString()} ر.س</td>
                            <td>${sale.tax.toLocaleString()} ر.س</td>
                            <td>${sale.total.toLocaleString()} ر.س</td>
                            <td><span style="padding: 3px 10px; border-radius: 15px; background: ${statusColor}; color: white;">${statusText}</span></td>
                            <td>${typeText}</td>
                            <td class="action-buttons">
                                <button class="btn" onclick="viewInvoice(${sale.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${!sale.isReturn && sale.status !== 'cancelled' ? `
                                    <button class="btn btn-info" onclick="showPaymentForm(${sale.id})" style="padding: 5px 10px;">
                                        <i class="fas fa-credit-card"></i>
                                    </button>
                                ` : ''}
                                ${!sale.isReturn && currentUser.role === 'admin' ? `
                                    <button class="btn btn-danger" onclick="deleteSale(${sale.id})" style="padding: 5px 10px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                salesTableHTML += `</tbody></table>`;
            } else {
                salesTableHTML = '<div class="data-empty"><i class="fas fa-shopping-cart"></i><p>لا توجد مبيعات مسجلة</p></div>';
            }
            
            document.getElementById('salesTableContainer').innerHTML = salesTableHTML;
        }
        
        function showNewSaleForm() {
            saleItems = [];
            currentSaleId = null;
            document.getElementById('newSaleForm').style.display = 'block';
            updateSaleItemsTable();
        }
        
        function hideNewSaleForm() {
            document.getElementById('newSaleForm').style.display = 'none';
            resetSaleForm();
        }
        
        function resetSaleForm() {
            document.getElementById('invoiceNo').value = `INV-${new Date().getFullYear()}-${String(loadData('sales').length + 1).padStart(3, '0')}`;
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('saleCustomer').value = '';
            document.getElementById('saleTaxRate').value = companyInfo.taxRate || 15;
            document.getElementById('saleItemSelect').value = '';
            document.getElementById('saleItemQuantity').value = '';
            document.getElementById('saleItemPrice').value = '';
            document.getElementById('saleItemTotal').value = '';
            document.getElementById('saleSubtotal').value = '0';
            document.getElementById('saleDiscount').value = '0';
            document.getElementById('saleTax').value = '0';
            document.getElementById('saleTotal').value = '0';
            document.getElementById('saleNotes').value = '';
            saleItems = [];
            updateSaleItemsTable();
        }
        
        function updateCustomerTaxInfo() {
            const customerId = parseInt(document.getElementById('saleCustomer').value);
            const customers = loadData('customers');
            const customer = customers.find(c => c.id === customerId);
            
            if (customer) {
                if (customer.taxNumber) {
                    document.getElementById('saleTaxRate').value = companyInfo.taxRate || 15;
                } else {
                    document.getElementById('saleTaxRate').value = 0;
                }
                calculateSaleTotal();
            }
        }
        
        function updateSaleItemPrice() {
            const itemId = parseInt(document.getElementById('saleItemSelect').value);
            const items = loadData('items');
            const item = items.find(i => i.id === itemId);
            
            if (item) {
                const exchangeRate = companyInfo.exchangeRate || 1;
                const adjustedPrice = item.price * exchangeRate;
                document.getElementById('saleItemPrice').value = adjustedPrice.toFixed(2);
                calculateSaleItemTotal();
            }
        }
        
        function calculateSaleItemTotal() {
            const quantity = parseFloat(document.getElementById('saleItemQuantity').value) || 0;
            const price = parseFloat(document.getElementById('saleItemPrice').value) || 0;
            const total = quantity * price;
            document.getElementById('saleItemTotal').value = total.toFixed(2);
        }
        
        function addSaleItem() {
            const itemId = parseInt(document.getElementById('saleItemSelect').value);
            const quantity = parseFloat(document.getElementById('saleItemQuantity').value) || 0;
            const price = parseFloat(document.getElementById('saleItemPrice').value) || 0;
            
            if (!itemId || quantity <= 0 || price <= 0) {
                showNotification('يرجى اختيار صنف وإدخال الكمية والسعر', 'error');
                return;
            }
            
            const items = loadData('items');
            const item = items.find(i => i.id === itemId);
            
            if (!item) {
                showNotification('الصنف غير موجود', 'error');
                return;
            }
            
            if (item.stock < quantity) {
                showNotification(`الكمية المطلوبة (${quantity}) أكبر من المخزون المتاح (${item.stock})`, 'error');
                return;
            }
            
            const saleItem = {
                itemId: itemId,
                itemName: item.name,
                quantity: quantity,
                price: price,
                total: quantity * price
            };
            
            saleItems.push(saleItem);
            
            document.getElementById('saleItemSelect').value = '';
            document.getElementById('saleItemQuantity').value = '';
            document.getElementById('saleItemPrice').value = '';
            document.getElementById('saleItemTotal').value = '';
            
            updateSaleItemsTable();
            calculateSaleTotal();
        }
        
        function updateSaleItemsTable() {
            const tbody = document.getElementById('saleItemsTable');
            tbody.innerHTML = '';
            
            saleItems.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.itemName}</td>
                    <td>${item.quantity}</td>
                    <td>${item.price.toLocaleString()} ر.س</td>
                    <td>${item.total.toLocaleString()} ر.س</td>
                    <td class="action-buttons">
                        <button class="btn btn-danger" onclick="removeSaleItem(${index})" style="padding: 5px 10px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        function removeSaleItem(index) {
            saleItems.splice(index, 1);
            updateSaleItemsTable();
            calculateSaleTotal();
        }
        
        function calculateSaleTotal() {
            const subtotal = saleItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const taxRate = parseFloat(document.getElementById('saleTaxRate').value) || 0;
            const taxableAmount = subtotal - discount;
            const tax = taxableAmount * (taxRate / 100);
            const total = taxableAmount + tax;
            
            document.getElementById('saleSubtotal').value = subtotal.toLocaleString();
            document.getElementById('saleTax').value = tax.toLocaleString();
            document.getElementById('saleTotal').value = total.toLocaleString();
        }
        
        function saveSale() {
            const customerId = parseInt(document.getElementById('saleCustomer').value);
            const date = document.getElementById('saleDate').value;
            
            if (!customerId) {
                showNotification('يرجى اختيار العميل', 'error');
                return;
            }
            
            if (saleItems.length === 0) {
                showNotification('يرجى إضافة أصناف للفاتورة', 'error');
                return;
            }
            
            const customers = loadData('customers');
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) {
                showNotification('العميل غير موجود', 'error');
                return;
            }
            
            let items = loadData('items');
            let hasStockIssue = false;
            
            for (const saleItem of saleItems) {
                const itemIndex = items.findIndex(i => i.id === saleItem.itemId);
                if (itemIndex !== -1) {
                    if (items[itemIndex].stock < saleItem.quantity) {
                        hasStockIssue = true;
                        showNotification(`الكمية المطلوبة من ${saleItem.itemName} (${saleItem.quantity}) أكبر من المخزون المتاح (${items[itemIndex].stock})`, 'error');
                        break;
                    }
                }
            }
            
            if (hasStockIssue) return;
            
            const subtotal = saleItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const taxRate = parseFloat(document.getElementById('saleTaxRate').value) || 0;
            const taxableAmount = subtotal - discount;
            const tax = taxableAmount * (taxRate / 100);
            const total = taxableAmount + tax;
            const notes = document.getElementById('saleNotes').value.trim();
            
            const sale = {
                id: currentSaleId || Date.now(),
                invoiceNo: document.getElementById('invoiceNo').value,
                date: date,
                customerId: customerId,
                customerName: customer.name,
                items: [...saleItems],
                subtotal: subtotal,
                discount: discount,
                tax: tax,
                total: total,
                paid: 0,
                balance: total,
                status: 'pending',
                notes: notes,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString(),
                isReturn: false,
                orderId: null,
                financialYear: currentFinancialYear
            };
            
            let sales = loadData('sales');
            
            if (currentSaleId) {
                const index = sales.findIndex(s => s.id === currentSaleId);
                if (index !== -1) {
                    const oldSale = sales[index];
                    for (const oldItem of oldSale.items) {
                        const oldItemIndex = items.findIndex(i => i.id === oldItem.itemId);
                        if (oldItemIndex !== -1) {
                            items[oldItemIndex].stock = items[oldItemIndex].stock + oldItem.quantity;
                        }
                    }
                    
                    const oldCustomerIndex = customers.findIndex(c => c.id === oldSale.customerId);
                    if (oldCustomerIndex !== -1) {
                        customers[oldCustomerIndex].balance = (customers[oldCustomerIndex].balance || 0) - oldSale.balance;
                    }
                    
                    sales[index] = sale;
                }
            } else {
                sales.push(sale);
            }
            
            for (const saleItem of saleItems) {
                const itemIndex = items.findIndex(i => i.id === saleItem.itemId);
                if (itemIndex !== -1) {
                    items[itemIndex].stock = items[itemIndex].stock - saleItem.quantity;
                }
            }
            
            const customerIndex = customers.findIndex(c => c.id === customerId);
            if (customerIndex !== -1) {
                customers[customerIndex].balance = (customers[customerIndex].balance || 0) + sale.balance;
            }
            
            saveData('items', items);
            saveData('customers', customers);
            saveData('sales', sales);
            
            hideNewSaleForm();
            loadSalesData();
            showNotification(currentSaleId ? 'تم تعديل الفاتورة' : 'تم حفظ الفاتورة بنجاح', 'success');
        }
        
        function deleteSale(id) {
            if (confirm('هل تريد حذف هذه الفاتورة؟')) {
                let sales = loadData('sales');
                const sale = sales.find(s => s.id === id);
                
                if (sale) {
                    if (sale.status !== 'completed' && !sale.isReturn && currentUser.role === 'admin') {
                        let items = loadData('items');
                        for (const saleItem of sale.items) {
                            const itemIndex = items.findIndex(i => i.id === saleItem.itemId);
                            if (itemIndex !== -1) {
                                items[itemIndex].stock = items[itemIndex].stock + saleItem.quantity;
                            }
                        }
                        
                        let customers = loadData('customers');
                        const customerIndex = customers.findIndex(c => c.id === sale.customerId);
                        if (customerIndex !== -1) {
                            customers[customerIndex].balance = Math.max(0, customers[customerIndex].balance - sale.balance);
                        }
                        
                        saveData('items', items);
                        saveData('customers', customers);
                        
                        sales = sales.filter(s => s.id !== id);
                        saveData('sales', sales);
                        loadSalesData();
                        showNotification('تم حذف الفاتورة', 'success');
                    } else {
                        showNotification('لا يمكن حذف فاتورة مكتملة أو مرتجع', 'error');
                    }
                }
            }
        }
        
        function filterSales() {
            const fromDate = document.getElementById('salesFromDate').value;
            const toDate = document.getElementById('salesToDate').value;
            const status = document.getElementById('salesStatusFilter').value;
            const customerId = document.getElementById('salesCustomerFilter').value;
            
            let sales = loadData('sales').filter(s => s.financialYear === currentFinancialYear);
            
            if (fromDate) {
                sales = sales.filter(s => s.date >= fromDate);
            }
            
            if (toDate) {
                sales = sales.filter(s => s.date <= toDate);
            }
            
            if (status) {
                sales = sales.filter(s => s.status === status);
            }
            
            if (customerId) {
                sales = sales.filter(s => s.customerId == customerId);
            }
            
            let salesTableHTML = '';
            
            if (sales.length > 0) {
                salesTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>العميل</th>
                                <th>الإجمالي</th>
                                <th>الضريبة</th>
                                <th>المجموع</th>
                                <th>الحالة</th>
                                <th>نوع</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                sales.reverse().forEach(sale => {
                    const statusColor = sale.status === 'completed' ? '#27ae60' : 
                                      sale.status === 'pending' ? '#f39c12' : '#e74c3c';
                    const statusText = sale.status === 'completed' ? 'مكتمل' : 
                                     sale.status === 'pending' ? 'قيد الانتظار' : 'ملغي';
                    const typeText = sale.isReturn ? '<span style="color: #e74c3c;">مرتجع</span>' : '<span style="color: #27ae60;">بيع</span>';
                    
                    salesTableHTML += `
                        <tr>
                            <td>${sale.invoiceNo}</td>
                            <td>${sale.date}</td>
                            <td>${sale.customerName}</td>
                            <td>${sale.subtotal.toLocaleString()} ر.س</td>
                            <td>${sale.tax.toLocaleString()} ر.س</td>
                            <td>${sale.total.toLocaleString()} ر.س</td>
                            <td><span style="padding: 3px 10px; border-radius: 15px; background: ${statusColor}; color: white;">${statusText}</span></td>
                            <td>${typeText}</td>
                            <td class="action-buttons">
                                <button class="btn" onclick="viewInvoice(${sale.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${!sale.isReturn && sale.status !== 'cancelled' ? `
                                    <button class="btn btn-info" onclick="showPaymentForm(${sale.id})" style="padding: 5px 10px;">
                                        <i class="fas fa-credit-card"></i>
                                    </button>
                                ` : ''}
                                ${!sale.isReturn && currentUser.role === 'admin' ? `
                                    <button class="btn btn-danger" onclick="deleteSale(${sale.id})" style="padding: 5px 10px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                salesTableHTML += `</tbody></table>`;
            } else {
                salesTableHTML = '<div class="data-empty"><i class="fas fa-search"></i><p>لا توجد نتائج للبحث</p></div>';
            }
            
            document.getElementById('salesTableContainer').innerHTML = salesTableHTML;
        }
        
        function resetSalesFilter() {
            document.getElementById('salesFromDate').value = '';
            document.getElementById('salesToDate').value = '';
            document.getElementById('salesStatusFilter').value = '';
            document.getElementById('salesCustomerFilter').value = '';
            loadSalesData();
        }
        
        function viewInvoice(id) {
            const sales = loadData('sales');
            const sale = sales.find(s => s.id === id);
            
            if (!sale) return;
            
            let invoiceHTML = `
                <div class="company-report-header">
                    ${companyInfo.logo ? `<img src="${companyInfo.logo}" class="report-logo" alt="شعار الشركة">` : '<h2>' + companyInfo.name + '</h2>'}
                    <p>${companyInfo.address}</p>
                    <p>هاتف: ${companyInfo.phone} | البريد: ${companyInfo.email}</p>
                    <p>الرقم الضريبي: ${companyInfo.taxNumber}</p>
                    <hr>
                    <h3>${sale.isReturn ? 'مرتجع فاتورة' : 'فاتورة بيع'} رقم: ${sale.invoiceNo}</h3>
                    <p>تاريخ الفاتورة: ${sale.date}</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <table>
                        <tr>
                            <td><strong>العميل:</strong></td>
                            <td>${sale.customerName}</td>
                        </tr>
                        <tr>
                            <td><strong>حالة الفاتورة:</strong></td>
                            <td>
                                <span style="padding: 3px 10px; border-radius: 15px; background: ${sale.status === 'completed' ? '#27ae60' : sale.status === 'pending' ? '#f39c12' : '#e74c3c'}; color: white;">
                                    ${sale.status === 'completed' ? 'مكتمل' : sale.status === 'pending' ? 'قيد الانتظار' : 'ملغي'}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>نوع الفاتورة:</strong></td>
                            <td>${sale.isReturn ? 'مرتجع' : 'بيع'}</td>
                        </tr>
                    </table>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>الصنف</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sale.items.forEach(item => {
                invoiceHTML += `
                    <tr>
                        <td>${item.itemName}</td>
                        <td>${item.quantity}</td>
                        <td>${item.price.toLocaleString()} ر.س</td>
                        <td>${item.total.toLocaleString()} ر.س</td>
                    </tr>
                `;
            });
            
            invoiceHTML += `
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <div>الإجمالي: ${sale.subtotal.toLocaleString()} ر.س</div>
                    <div>الخصم: ${sale.discount.toLocaleString()} ر.س</div>
                    <div>الضريبة: ${sale.tax.toLocaleString()} ر.س</div>
                    <div style="font-weight: bold; font-size: 18px;">المبلغ الإجمالي: ${sale.total.toLocaleString()} ر.س</div>
                    <div>المبلغ المدفوع: ${sale.paid.toLocaleString()} ر.س</div>
                    <div>الرصيد المتبقي: ${sale.balance.toLocaleString()} ر.س</div>
                </div>
                
                ${sale.notes ? `<div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px;"><strong>ملاحظات:</strong><br>${sale.notes}</div>` : ''}
                
                <div class="signature-section">
                    <h4>التوقيعات:</h4>
                    <div class="signature-row">
                        <div class="signature-box">
                            <p>مندوب المبيعات</p>
                            <div style="height: 50px; border-bottom: 1px solid #333;"></div>
                        </div>
                        <div class="signature-box">
                            <p>المحاسب</p>
                            <div style="height: 50px; border-bottom: 1px solid #333;"></div>
                        </div>
                        <div class="signature-box">
                            <p>العميل</p>
                            <div style="height: 50px; border-bottom: 1px solid #333;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('invoiceContent').innerHTML = invoiceHTML;
            document.getElementById('invoiceModal').style.display = 'flex';
        }
        
        function printInvoice() {
            const invoiceContent = document.getElementById('invoiceContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>طباعة الفاتورة</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
                        .company-report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #ddd; padding-bottom: 20px; }
                        .report-logo { max-width: 150px; max-height: 150px; margin-bottom: 20px; }
                        .signature-section { margin-top: 50px; }
                        .signature-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
                        .signature-box { text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #ddd; }
                        th { background: #f8f9fa; }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // ========== صفحة المصاريف ==========
        function loadExpensesPage() {
            return `
                <div class="page-header">
                    <h2><i class="fas fa-money-bill"></i> إدارة المصاريف</h2>
                    <button class="btn" onclick="showExpenseForm()">
                        <i class="fas fa-plus-circle"></i> إضافة مصروف جديد
                    </button>
                </div>
                
                <div class="form-container" id="expenseForm" style="display: none;">
                    <h3><i class="fas fa-money-bill"></i> ${currentExpenseId ? 'تعديل مصروف' : 'إضافة مصروف جديد'}</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>تاريخ المصروف:</label>
                            <input type="date" id="expenseDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>نوع المصروف:</label>
                            <select id="expenseType">
                                <option value="مرتبات">مرتبات</option>
                                <option value="كهرباء">كهرباء</option>
                                <option value="صيانة">صيانة</option>
                                <option value="إيجار">إيجار</option>
                                <option value="وقود">وقود</option>
                                <option value="نقل">نقل</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>المبلغ:</label>
                            <input type="number" id="expenseAmount" placeholder="المبلغ" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>الوصف:</label>
                        <textarea id="expenseDescription" rows="3" placeholder="وصف المصروف"></textarea>
                    </div>
                    <button class="btn" onclick="saveExpense()">
                        <i class="fas fa-save"></i> ${currentExpenseId ? 'تحديث' : 'حفظ'}
                    </button>
                    <button class="btn btn-secondary" onclick="hideExpenseForm()" style="margin-right: 10px;">
                        إلغاء
                    </button>
                </div>
                
                <div class="filter-container">
                    <div class="filter-row">
                        <div class="form-group">
                            <label>من تاريخ:</label>
                            <input type="date" id="expensesFromDate">
                        </div>
                        <div class="form-group">
                            <label>إلى تاريخ:</label>
                            <input type="date" id="expensesToDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>نوع المصروف:</label>
                            <select id="expensesTypeFilter">
                                <option value="">جميع الأنواع</option>
                                <option value="مرتبات">مرتبات</option>
                                <option value="كهرباء">كهرباء</option>
                                <option value="صيانة">صيانة</option>
                                <option value="إيجار">إيجار</option>
                                <option value="وقود">وقود</option>
                                <option value="نقل">نقل</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="filterExpenses()">
                                <i class="fas fa-filter"></i> تصفية
                            </button>
                            <button class="btn btn-secondary" onclick="resetExpensesFilter()" style="margin-right: 10px;">
                                <i class="fas fa-redo"></i> إعادة تعيين
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="expensesTableContainer">
                    <!-- سيتم تحميل البيانات -->
                </div>
            `;
        }
        
        let currentExpenseId = null;
        
        function loadExpensesData() {
            const expenses = loadData('expenses').filter(e => e.financialYear === currentFinancialYear);
            let expensesTableHTML = '';
            
            if (expenses.length > 0) {
                expensesTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>النوع</th>
                                <th>المبلغ</th>
                                <th>الوصف</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                expenses.reverse().forEach(expense => {
                    expensesTableHTML += `
                        <tr>
                            <td>${expense.date}</td>
                            <td><span style="padding: 3px 10px; border-radius: 15px; background: #e3f2fd; color: #1565c0;">${expense.type}</span></td>
                            <td class="loss">${expense.amount.toLocaleString()} ر.س</td>
                            <td>${expense.description || '-'}</td>
                            <td class="action-buttons">
                                <button class="btn" onclick="editExpense(${expense.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteExpense(${expense.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                expensesTableHTML += `</tbody></table>`;
            } else {
                expensesTableHTML = '<div class="data-empty"><i class="fas fa-money-bill"></i><p>لا توجد مصروفات مسجلة</p></div>';
            }
            
            document.getElementById('expensesTableContainer').innerHTML = expensesTableHTML;
        }
        
        function showExpenseForm() {
            document.getElementById('expenseForm').style.display = 'block';
        }
        
        function hideExpenseForm() {
            document.getElementById('expenseForm').style.display = 'none';
            currentExpenseId = null;
            resetExpenseForm();
        }
        
        function resetExpenseForm() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseType').value = 'مرتبات';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDescription').value = '';
        }
        
        function saveExpense() {
            const date = document.getElementById('expenseDate').value;
            const type = document.getElementById('expenseType').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const description = document.getElementById('expenseDescription').value.trim();
            
            if (!date || amount <= 0) {
                showNotification('يرجى إدخال تاريخ ومبلغ صحيح', 'error');
                return;
            }
            
            const expense = {
                id: currentExpenseId || Date.now(),
                date: date,
                type: type,
                amount: amount,
                description: description,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString(),
                financialYear: currentFinancialYear
            };
            
            let expenses = loadData('expenses');
            
            if (currentExpenseId) {
                const index = expenses.findIndex(e => e.id === currentExpenseId);
                if (index !== -1) {
                    expenses[index] = expense;
                }
            } else {
                expenses.push(expense);
            }
            
            saveData('expenses', expenses);
            
            hideExpenseForm();
            loadExpensesData();
            showNotification(currentExpenseId ? 'تم تعديل المصروف' : 'تم إضافة المصروف بنجاح', 'success');
        }
        
        function editExpense(id) {
            const expenses = loadData('expenses');
            const expense = expenses.find(e => e.id === id);
            
            if (expense) {
                currentExpenseId = id;
                document.getElementById('expenseDate').value = expense.date;
                document.getElementById('expenseType').value = expense.type;
                document.getElementById('expenseAmount').value = expense.amount;
                document.getElementById('expenseDescription').value = expense.description || '';
                showExpenseForm();
            }
        }
        
        function deleteExpense(id) {
            if (confirm('هل تريد حذف هذا المصروف؟')) {
                let expenses = loadData('expenses');
                expenses = expenses.filter(e => e.id !== id);
                saveData('expenses', expenses);
                loadExpensesData();
                showNotification('تم حذف المصروف', 'success');
            }
        }
        
        function filterExpenses() {
            const fromDate = document.getElementById('expensesFromDate').value;
            const toDate = document.getElementById('expensesToDate').value;
            const type = document.getElementById('expensesTypeFilter').value;
            
            let expenses = loadData('expenses').filter(e => e.financialYear === currentFinancialYear);
            
            if (fromDate) {
                expenses = expenses.filter(e => e.date >= fromDate);
            }
            
            if (toDate) {
                expenses = expenses.filter(e => e.date <= toDate);
            }
            
            if (type) {
                expenses = expenses.filter(e => e.type === type);
            }
            
            let expensesTableHTML = '';
            
            if (expenses.length > 0) {
                expensesTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>النوع</th>
                                <th>المبلغ</th>
                                <th>الوصف</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                expenses.reverse().forEach(expense => {
                    expensesTableHTML += `
                        <tr>
                            <td>${expense.date}</td>
                            <td><span style="padding: 3px 10px; border-radius: 15px; background: #e3f2fd; color: #1565c0;">${expense.type}</span></td>
                            <td class="loss">${expense.amount.toLocaleString()} ر.س</td>
                            <td>${expense.description || '-'}</td>
                            <td class="action-buttons">
                                <button class="btn" onclick="editExpense(${expense.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteExpense(${expense.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                expensesTableHTML += `</tbody></table>`;
            } else {
                expensesTableHTML = '<div class="data-empty"><i class="fas fa-search"></i><p>لا توجد نتائج للبحث</p></div>';
            }
            
            document.getElementById('expensesTableContainer').innerHTML = expensesTableHTML;
        }
        
        function resetExpensesFilter() {
            document.getElementById('expensesFromDate').value = '';
            document.getElementById('expensesToDate').value = '';
            document.getElementById('expensesTypeFilter').value = '';
            loadExpensesData();
        }
        
        // ========== صفحة حساب التكلفة ==========
        function loadCostCalculationPage() {
            return `
                <div class="page-header">
                    <h2><i class="fas fa-calculator"></i> حساب تكلفة الإنتاج</h2>
                    <button class="btn" onclick="showCostForm()">
                        <i class="fas fa-plus-circle"></i> إضافة تكلفة إنتاج
                    </button>
                </div>
                
                <div class="form-container" id="costForm" style="display: none;">
                    <h3><i class="fas fa-calculator"></i> ${currentCostId ? 'تعديل تكلفة' : 'إضافة تكلفة إنتاج'}</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>الشهر:</label>
                            <select id="costMonth">
                                ${Array.from({length: 12}, (_, i) => `
                                    <option value="${i+1}">${i+1}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>السنة:</label>
                            <input type="number" id="costYear" value="${new Date().getFullYear()}" min="2020" max="2030">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>الصنف:</label>
                            <select id="costItem">
                                <option value="">اختر الصنف</option>
                                ${loadData('items').map(item => `
                                    <option value="${item.id}">${item.code} - ${item.name}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>تكلفة الإنتاج الأساسية (للطن):</label>
                            <input type="number" id="productionCost" placeholder="تكلفة الإنتاج" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>تكاليف إضافية (للطن):</label>
                            <input type="number" id="additionalCosts" placeholder="تكاليف إضافية" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>التكلفة الإجمالية (للطن):</label>
                            <input type="number" id="totalCost" placeholder="التكلفة الإجمالية" readonly style="background: #f8f9fa;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ملاحظات:</label>
                        <textarea id="costNotes" rows="2" placeholder="ملاحظات حول التكلفة"></textarea>
                    </div>
                    <button class="btn" onclick="calculateTotalCost()">
                        <i class="fas fa-calculator"></i> حساب التكلفة
                    </button>
                    <button class="btn btn-success" onclick="saveCost()" style="margin-right: 10px;">
                        <i class="fas fa-save"></i> ${currentCostId ? 'تحديث' : 'حفظ'}
                    </button>
                    <button class="btn btn-secondary" onclick="hideCostForm()" style="margin-right: 10px;">
                        إلغاء
                    </button>
                </div>
                
                <div class="form-container">
                    <h3><i class="fas fa-chart-pie"></i> تكاليف الإنتاج الشهرية</h3>
                    <div class="filter-container">
                        <div class="filter-row">
                            <div class="form-group">
                                <label>السنة:</label>
                                <input type="number" id="costYearFilter" value="${new Date().getFullYear()}" min="2020" max="2030" onchange="filterCosts()">
                            </div>
                            <div class="form-group">
                                <label>الصنف:</label>
                                <select id="costItemFilter" onchange="filterCosts()">
                                    <option value="">جميع الأصناف</option>
                                    ${loadData('items').map(item => `
                                        <option value="${item.id}">${item.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="costsTableContainer">
                        <!-- سيتم تحميل البيانات -->
                    </div>
                </div>
            `;
        }
        
        let currentCostId = null;
        
        function loadCostCalculationData() {
            filterCosts();
        }
        
        function showCostForm() {
            document.getElementById('costForm').style.display = 'block';
        }
        
        function hideCostForm() {
            document.getElementById('costForm').style.display = 'none';
            currentCostId = null;
            resetCostForm();
        }
        
        function resetCostForm() {
            const today = new Date();
            document.getElementById('costMonth').value = today.getMonth() + 1;
            document.getElementById('costYear').value = today.getFullYear();
            document.getElementById('costItem').value = '';
            document.getElementById('productionCost').value = '';
            document.getElementById('additionalCosts').value = '';
            document.getElementById('totalCost').value = '';
            document.getElementById('costNotes').value = '';
        }
        
        function calculateTotalCost() {
            const productionCost = parseFloat(document.getElementById('productionCost').value) || 0;
            const additionalCosts = parseFloat(document.getElementById('additionalCosts').value) || 0;
            const totalCost = productionCost + additionalCosts;
            document.getElementById('totalCost').value = totalCost.toFixed(2);
        }
        
        function saveCost() {
            const month = parseInt(document.getElementById('costMonth').value);
            const year = parseInt(document.getElementById('costYear').value);
            const itemId = parseInt(document.getElementById('costItem').value);
            const productionCost = parseFloat(document.getElementById('productionCost').value) || 0;
            const additionalCosts = parseFloat(document.getElementById('additionalCosts').value) || 0;
            const totalCost = parseFloat(document.getElementById('totalCost').value) || 0;
            const notes = document.getElementById('costNotes').value.trim();
            
            if (!itemId || productionCost <= 0) {
                showNotification('يرجى اختيار صنف وإدخال تكلفة إنتاج صحيحة', 'error');
                return;
            }
            
            const items = loadData('items');
            const item = items.find(i => i.id === itemId);
            
            if (!item) {
                showNotification('الصنف غير موجود', 'error');
                return;
            }
            
            const cost = {
                id: currentCostId || Date.now(),
                month: month,
                year: year,
                itemId: itemId,
                itemName: item.name,
                productionCost: productionCost,
                additionalCosts: additionalCosts,
                totalCost: totalCost,
                notes: notes,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            let costs = loadData('productionCosts');
            
            if (currentCostId) {
                const index = costs.findIndex(c => c.id === currentCostId);
                if (index !== -1) {
                    costs[index] = cost;
                }
            } else {
                costs.push(cost);
            }
            
            saveData('productionCosts', costs);
            
            hideCostForm();
            filterCosts();
            showNotification(currentCostId ? 'تم تعديل التكلفة' : 'تم إضافة التكلفة بنجاح', 'success');
        }
        
        function filterCosts() {
            const year = parseInt(document.getElementById('costYearFilter').value) || new Date().getFullYear();
            const itemId = document.getElementById('costItemFilter').value;
            
            let costs = loadData('productionCosts').filter(cost => cost.year === year);
            
            if (itemId) {
                costs = costs.filter(cost => cost.itemId == itemId);
            }
            
            let costsTableHTML = '';
            
            if (costs.length > 0) {
                costsTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>الشهر/السنة</th>
                                <th>الصنف</th>
                                <th>تكلفة الإنتاج</th>
                                <th>تكاليف إضافية</th>
                                <th>التكلفة الإجمالية</th>
                                <th>ملاحظات</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                costs.forEach(cost => {
                    costsTableHTML += `
                        <tr>
                            <td>${cost.month}/${cost.year}</td>
                            <td>${cost.itemName}</td>
                            <td>${cost.productionCost.toLocaleString()} ر.س</td>
                            <td>${cost.additionalCosts.toLocaleString()} ر.س</td>
                            <td class="loss">${cost.totalCost.toLocaleString()} ر.س</td>
                            <td>${cost.notes || '-'}</td>
                            <td class="action-buttons">
                                <button class="btn" onclick="editCost(${cost.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteCost(${cost.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                costsTableHTML += `</tbody></table>`;
            } else {
                costsTableHTML = '<div class="data-empty"><i class="fas fa-calculator"></i><p>لا توجد تكاليف مسجلة لهذا الفلتر</p></div>';
            }
            
            document.getElementById('costsTableContainer').innerHTML = costsTableHTML;
        }
        
        function editCost(id) {
            const costs = loadData('productionCosts');
            const cost = costs.find(c => c.id === id);
            
            if (cost) {
                currentCostId = id;
                document.getElementById('costMonth').value = cost.month;
                document.getElementById('costYear').value = cost.year;
                document.getElementById('costItem').value = cost.itemId;
                document.getElementById('productionCost').value = cost.productionCost;
                document.getElementById('additionalCosts').value = cost.additionalCosts;
                document.getElementById('totalCost').value = cost.totalCost;
                document.getElementById('costNotes').value = cost.notes || '';
                showCostForm();
            }
        }
        
        function deleteCost(id) {
            if (confirm('هل تريد حذف هذه التكلفة؟')) {
                let costs = loadData('productionCosts');
                costs = costs.filter(c => c.id !== id);
                saveData('productionCosts', costs);
                filterCosts();
                showNotification('تم حذف التكلفة', 'success');
            }
        }
        
        // ========== صفحة سداد المدفوعات ==========
        function loadPaymentsPage() {
            return `
                <div class="page-header">
                    <h2><i class="fas fa-credit-card"></i> سداد المدفوعات</h2>
                </div>
                
                <div class="form-container">
                    <h3><i class="fas fa-search"></i> البحث عن فواتير العميل</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>اختر العميل:</label>
                            <select id="paymentCustomerSelect" onchange="loadCustomerInvoices()">
                                <option value="">اختر العميل</option>
                                ${loadData('customers').map(customer => `
                                    <option value="${customer.id}">${customer.name} (${(customer.balance || 0).toLocaleString()} ر.س)</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div id="customerInvoicesSection" style="display: none;">
                        <h4>فواتير العميل</h4>
                        <div id="customerInvoicesTable">
                            <!-- سيتم تحميل فواتير العميل هنا -->
                        </div>
                    </div>
                </div>
                
                <div id="paymentsHistorySection" style="margin-top: 30px;">
                    <h3><i class="fas fa-history"></i> سجل المدفوعات</h3>
                    <div id="paymentsTableContainer">
                        <!-- سيتم تحميل سجل المدفوعات هنا -->
                    </div>
                </div>
            `;
        }
        
        function loadPaymentsData() {
            const payments = loadData('payments').filter(p => p.financialYear === currentFinancialYear);
            let paymentsTableHTML = '';
            
            if (payments.length > 0) {
                paymentsTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>المبلغ</th>
                                <th>طريقة الدفع</th>
                                <th>ملاحظات</th>
                                <th>الإجراءات</th>
                            </tr>
                            </thead>
                            <tbody>
                `;
                
                payments.reverse().forEach(payment => {
                    paymentsTableHTML += `
                        <tr>
                            <td>${payment.invoiceNo}</td>
                            <td>${payment.date}</td>
                            <td class="profit">${payment.amount.toLocaleString()} ر.س</td>
                            <td>${payment.paymentMethod}</td>
                            <td>${payment.notes || '-'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-danger" onclick="deletePayment(${payment.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                paymentsTableHTML += `</tbody></table>`;
            } else {
                paymentsTableHTML = '<div class="data-empty"><i class="fas fa-credit-card"></i><p>لا توجد مدفوعات مسجلة</p></div>';
            }
            
            document.getElementById('paymentsTableContainer').innerHTML = paymentsTableHTML;
        }
        
        function loadCustomerInvoices() {
            const customerId = parseInt(document.getElementById('paymentCustomerSelect').value);
            if (!customerId) {
                document.getElementById('customerInvoicesSection').style.display = 'none';
                return;
            }
            
            const sales = loadData('sales').filter(s => 
                s.customerId === customerId && 
                !s.isReturn && 
                s.status !== 'cancelled' &&
                s.balance > 0 &&
                s.financialYear === currentFinancialYear
            );
            
            let invoicesHTML = '';
            
            if (sales.length > 0) {
                invoicesHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>الإجمالي</th>
                                <th>الضريبة</th>
                                <th>المجموع</th>
                                <th>المتبقي</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                sales.forEach(sale => {
                    invoicesHTML += `
                        <tr>
                            <td>${sale.invoiceNo}</td>
                            <td>${sale.date}</td>
                            <td>${sale.subtotal.toLocaleString()} ر.س</td>
                            <td>${sale.tax.toLocaleString()} ر.س</td>
                            <td>${sale.total.toLocaleString()} ر.س</td>
                            <td class="loss">${sale.balance.toLocaleString()} ر.س</td>
                            <td class="action-buttons">
                                <button class="btn btn-info" onclick="showPaymentForm(${sale.id})" style="padding: 5px 10px;">
                                    <i class="fas fa-credit-card"></i> سداد
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                invoicesHTML += `</tbody></table>`;
            } else {
                invoicesHTML = '<div class="data-empty"><i class="fas fa-file-invoice"></i><p>لا توجد فواتير مستحقة لهذا العميل</p></div>';
            }
            
            document.getElementById('customerInvoicesTable').innerHTML = invoicesHTML;
            document.getElementById('customerInvoicesSection').style.display = 'block';
        }
        
        function showPaymentForm(saleId) {
            const sales = loadData('sales');
            const sale = sales.find(s => s.id === saleId);
            
            if (!sale) return;
            
            let paymentHTML = `
                <div class="payment-form">
                    <h4>سداد فاتورة رقم: ${sale.invoiceNo}</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>المبلغ المتبقي:</label>
                            <input type="text" id="remainingBalance" value="${sale.balance.toLocaleString()} ر.س" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label>المبلغ المسدد:</label>
                            <input type="number" id="paymentAmount" placeholder="المبلغ المسدد" step="0.01" max="${sale.balance}" value="${sale.balance}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>طريقة الدفع:</label>
                            <select id="paymentMethod">
                                <option value="نقدي">نقدي</option>
                                <option value="تحويل بنكي">تحويل بنكي</option>
                                <option value="شيك">شيك</option>
                                <option value="بطاقة ائتمان">بطاقة ائتمان</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>تاريخ السداد:</label>
                            <input type="date" id="paymentDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ملاحظات:</label>
                        <textarea id="paymentNotes" rows="2" placeholder="ملاحظات إضافية"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="processPayment(${saleId})">
                        <i class="fas fa-check"></i> تأكيد السداد
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('paymentModal')" style="margin-right: 10px;">
                        إلغاء
                    </button>
                </div>
            `;
            
            document.getElementById('paymentContent').innerHTML = paymentHTML;
            document.getElementById('paymentModal').style.display = 'flex';
        }
        
        function processPayment(saleId) {
            const sales = loadData('sales');
            const saleIndex = sales.findIndex(s => s.id === saleId);
            
            if (saleIndex === -1) return;
            
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const remainingBalance = sales[saleIndex].balance;
            
            if (paymentAmount <= 0 || paymentAmount > remainingBalance) {
                showNotification('يرجى إدخال مبلغ صحيح', 'error');
                return;
            }
            
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNotes = document.getElementById('paymentNotes').value.trim();
            
            sales[saleIndex].paid += paymentAmount;
            sales[saleIndex].balance -= paymentAmount;
            
            if (sales[saleIndex].balance <= 0) {
                sales[saleIndex].status = 'completed';
            }
            
            const payment = {
                id: Date.now(),
                invoiceId: saleId,
                invoiceNo: sales[saleIndex].invoiceNo,
                date: paymentDate,
                amount: paymentAmount,
                paymentMethod: paymentMethod,
                notes: paymentNotes,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString(),
                financialYear: currentFinancialYear
            };
            
            let payments = loadData('payments');
            payments.push(payment);
            
            let customers = loadData('customers');
            const customerIndex = customers.findIndex(c => c.id === sales[saleIndex].customerId);
            if (customerIndex !== -1) {
                customers[customerIndex].balance = Math.max(0, customers[customerIndex].balance - paymentAmount);
            }
            
            saveData('sales', sales);
            saveData('payments', payments);
            saveData('customers', customers);
            
            closeModal('paymentModal');
            loadPaymentsData();
            if (document.getElementById('paymentCustomerSelect').value) {
                loadCustomerInvoices();
            }
            showNotification('تم تسجيل السداد بنجاح', 'success');
        }
        
        function deletePayment(id) {
            if (confirm('هل تريد حذف هذا السداد؟')) {
                let payments = loadData('payments');
                const payment = payments.find(p => p.id === id);
                
                if (payment) {
                    let sales = loadData('sales');
                    const saleIndex = sales.findIndex(s => s.id === payment.invoiceId);
                    
                    if (saleIndex !== -1) {
                        sales[saleIndex].paid -= payment.amount;
                        sales[saleIndex].balance += payment.amount;
                        
                        if (sales[saleIndex].balance > 0) {
                            sales[saleIndex].status = 'pending';
                        }
                        
                        let customers = loadData('customers');
                        const customerIndex = customers.findIndex(c => c.id === sales[saleIndex].customerId);
                        if (customerIndex !== -1) {
                            customers[customerIndex].balance = (customers[customerIndex].balance || 0) + payment.amount;
                        }
                        
                        saveData('sales', sales);
                        saveData('customers', customers);
                    }
                    
                    payments = payments.filter(p => p.id !== id);
                    saveData('payments', payments);
                    loadPaymentsData();
                    showNotification('تم حذف السداد', 'success');
                }
            }
        }
        
        // ========== صفحة السنوات المالية ==========
        function loadFinancialYearsPage() {
            if (currentUser.role !== 'admin') {
                return `
                    <div class="page-header">
                        <h2><i class="fas fa-calendar"></i> السنوات المالية</h2>
                    </div>
                    <div class="data-empty">
                        <i class="fas fa-lock"></i>
                        <p>ليس لديك صلاحية للوصول إلى هذه الصفحة</p>
                    </div>
                `;
            }
            
            return `
                <div class="page-header">
                    <h2><i class="fas fa-calendar"></i> إدارة السنوات المالية</h2>
                    <button class="btn" onclick="showNewYearForm()">
                        <i class="fas fa-plus-circle"></i> إضافة سنة مالية
                    </button>
                </div>
                
                <div class="form-container" id="newYearForm" style="display: none;">
                    <h3><i class="fas fa-plus-circle"></i> إضافة سنة مالية جديدة</h3>
                    <div class="warning-box">
                        <p><i class="fas fa-exclamation-triangle"></i> <strong>تنبيه:</strong> يمكن أن تكون هناك سنة مالية واحدة مفتوحة فقط في نفس الوقت.</p>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>السنة:</label>
                            <input type="number" id="newYear" value="${new Date().getFullYear() + 1}" min="${new Date().getFullYear()}" max="2030">
                        </div>
                        <div class="form-group">
                            <label>تاريخ البدء:</label>
                            <input type="date" id="yearStartDate" value="${new Date().getFullYear() + 1}-01-01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ملاحظات:</label>
                        <textarea id="yearNotes" rows="2" placeholder="ملاحظات حول السنة المالية"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="addFinancialYear()">
                        <i class="fas fa-save"></i> إضافة سنة مالية
                    </button>
                    <button class="btn btn-secondary" onclick="hideNewYearForm()" style="margin-right: 10px;">
                        إلغاء
                    </button>
                </div>
                
                <div class="form-container">
                    <h3><i class="fas fa-list"></i> السنوات المالية المسجلة</h3>
                    <div id="financialYearsTableContainer">
                        <!-- سيتم تحميل البيانات -->
                    </div>
                </div>
            `;
        }
        
        function loadFinancialYearsData() {
            if (currentUser.role !== 'admin') return;
            
            let yearsTableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>السنة</th>
                            <th>تاريخ البدء</th>
                            <th>تاريخ الإغلاق</th>
                            <th>الحالة</th>
                            <th>إجمالي المبيعات</th>
                            <th>إجمالي المصاريف</th>
                            <th>صافي الدخل</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            financialYears.forEach(year => {
                const statusText = year.status === 'open' ? 'مفتوحة' : 'مغلقة';
                const statusClass = year.status === 'open' ? 'open' : 'closed';
                
                yearsTableHTML += `
                    <tr>
                        <td>${year.year}</td>
                        <td>${year.openingDate}</td>
                        <td>${year.closingDate || 'لم يتم الإغلاق'}</td>
                        <td><span class="year-status ${statusClass}">${statusText}</span></td>
                        <td>${year.totalSales.toLocaleString()} ر.س</td>
                        <td class="loss">${year.totalExpenses.toLocaleString()} ر.س</td>
                        <td class="${year.netProfit >= 0 ? 'profit' : 'loss'}">${year.netProfit.toLocaleString()} ر.س</td>
                        <td class="action-buttons">
                            ${year.status === 'open' ? `
                                <button class="btn btn-warning" onclick="closeFinancialYear(${year.year})" style="padding: 5px 10px;">
                                    <i class="fas fa-lock"></i> إغلاق السنة
                                </button>
                            ` : ''}
                            ${year.status === 'closed' ? `
                                <button class="btn btn-info" onclick="viewYearReport(${year.year})" style="padding: 5px 10px;">
                                    <i class="fas fa-eye"></i> عرض التقرير
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            yearsTableHTML += `</tbody></table>`;
            
            document.getElementById('financialYearsTableContainer').innerHTML = yearsTableHTML;
        }
        
        function showNewYearForm() {
            if (currentUser.role !== 'admin') return;
            document.getElementById('newYearForm').style.display = 'block';
        }
        
        function hideNewYearForm() {
            document.getElementById('newYearForm').style.display = 'none';
            resetYearForm();
        }
        
        function resetYearForm() {
            const nextYear = new Date().getFullYear() + 1;
            document.getElementById('newYear').value = nextYear;
            document.getElementById('yearStartDate').value = `${nextYear}-01-01`;
            document.getElementById('yearNotes').value = '';
        }
        
        function addFinancialYear() {
            if (currentUser.role !== 'admin') return;
            
            const year = parseInt(document.getElementById('newYear').value);
            const startDate = document.getElementById('yearStartDate').value;
            const notes = document.getElementById('yearNotes').value.trim();
            
            if (!year || !startDate) {
                showNotification('يرجى إدخال السنة وتاريخ البدء', 'error');
                return;
            }
            
            // التحقق من عدم وجود سنة مفتوحة أخرى
            const hasOpenYear = financialYears.some(y => y.status === 'open');
            if (hasOpenYear) {
                showNotification('يوجد بالفعل سنة مالية مفتوحة. يجب إغلاق السنة الحالية أولاً', 'error');
                return;
            }
            
            // التحقق من عدم تكرار السنة
            const yearExists = financialYears.some(y => y.year === year);
            if (yearExists) {
                showNotification('هذه السنة مسجلة مسبقاً', 'error');
                return;
            }
            
            const newYear = {
                year: year,
                status: 'open',
                openingBalance: 0,
                openingDate: startDate,
                closingDate: null,
                totalSales: 0,
                totalExpenses: 0,
                netProfit: 0,
                notes: notes
            };
            
            financialYears.push(newYear);
            saveData('financialYears', financialYears);
            
            currentFinancialYear = year;
            updateFinancialYearUI();
            
            hideNewYearForm();
            loadFinancialYearsData();
            showNotification('تم إضافة السنة المالية الجديدة بنجاح', 'success');
        }
        
        function closeFinancialYear(year) {
            if (currentUser.role !== 'admin') return;
            
            if (!confirm(`هل تريد إغلاق السنة المالية ${year}؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
                return;
            }
            
            const yearIndex = financialYears.findIndex(y => y.year === year);
            if (yearIndex === -1) return;
            
            // حساب إجماليات السنة
            const yearSales = loadData('sales').filter(s => s.financialYear === year);
            const yearExpenses = loadData('expenses').filter(e => e.financialYear === year);
            
            const totalSales = yearSales
                .filter(s => !s.isReturn)
                .reduce((sum, sale) => sum + sale.total, 0);
            
            const totalReturns = yearSales
                .filter(s => s.isReturn)
                .reduce((sum, sale) => sum + sale.total, 0);
            
            const netSales = totalSales - totalReturns;
            const totalExpenses = yearExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const netProfit = netSales - totalExpenses;
            
            financialYears[yearIndex].status = 'closed';
            financialYears[yearIndex].closingDate = new Date().toISOString().split('T')[0];
            financialYears[yearIndex].totalSales = netSales;
            financialYears[yearIndex].totalExpenses = totalExpenses;
            financialYears[yearIndex].netProfit = netProfit;
            
            saveData('financialYears', financialYears);
            
            // البحث عن سنة مفتوحة أخرى أو تعيين سنة جديدة
            const openYear = financialYears.find(y => y.status === 'open');
            if (openYear) {
                currentFinancialYear = openYear.year;
            }
            
            updateFinancialYearUI();
            loadFinancialYearsData();
            showNotification(`تم إغلاق السنة المالية ${year} بنجاح`, 'success');
        }
        
        function viewYearReport(year) {
            const yearData = financialYears.find(y => y.year === year);
            if (!yearData) return;
            
            let reportHTML = `
                <div class="form-container">
                    <h3><i class="fas fa-file-alt"></i> تقرير السنة المالية ${year}</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; text-align: center;">
                                <div>تاريخ البدء</div>
                                <div class="summary-value">${yearData.openingDate}</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="background: #ffebee; padding: 15px; border-radius: 10px; text-align: center;">
                                <div>تاريخ الإغلاق</div>
                                <div class="summary-value">${yearData.closingDate || 'لم يتم الإغلاق'}</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center;">
                                <div>الحالة</div>
                                <div class="summary-value">${yearData.status === 'open' ? 'مفتوحة' : 'مغلقة'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; text-align: center;">
                                <div>إجمالي المبيعات</div>
                                <div class="summary-value">${yearData.totalSales.toLocaleString()} ر.س</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="background: #ffebee; padding: 15px; border-radius: 10px; text-align: center;">
                                <div>إجمالي المصاريف</div>
                                <div class="summary-value">${yearData.totalExpenses.toLocaleString()} ر.س</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="background: ${yearData.netProfit >= 0 ? '#e8f5e9' : '#ffebee'}; padding: 15px; border-radius: 10px; text-align: center;">
                                <div>صافي الدخل</div>
                                <div class="summary-value ${yearData.netProfit >= 0 ? 'profit' : 'loss'}">${yearData.netProfit.toLocaleString()} ر.س</div>
                            </div>
                        </div>
                    </div>
                    
                    ${yearData.notes ? `
                        <div class="form-group">
                            <label>ملاحظات:</label>
                            <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                ${yearData.notes}
                            </div>
                        </div>
                    ` : ''}
                    
                    <button class="btn" onclick="printYearReport(${year})" style="margin-top: 20px;">
                        <i class="fas fa-print"></i> طباعة التقرير
                    </button>
                    <button class="btn btn-secondary" onclick="showPage('financialYears')" style="margin-right: 10px; margin-top: 20px;">
                        رجوع
                    </button>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = reportHTML;
        }
        
        function printYearReport(year) {
            const yearData = financialYears.find(y => y.year === year);
            if (!yearData) return;
            
            let printHTML = `
                <div class="company-report-header">
                    ${companyInfo.logo ? `<img src="${companyInfo.logo}" class="report-logo" alt="شعار الشركة">` : '<h2>' + companyInfo.name + '</h2>'}
                    <p>${companyInfo.address}</p>
                    <p>هاتف: ${companyInfo.phone} | البريد: ${companyInfo.email}</p>
                    <hr>
                    <h3>تقرير السنة المالية ${year}</h3>
                    <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <table>
                        <tr>
                            <td><strong>تاريخ البدء:</strong></td>
                            <td>${yearData.openingDate}</td>
                        </tr>
                        <tr>
                            <td><strong>تاريخ الإغلاق:</strong></td>
                            <td>${yearData.closingDate || 'لم يتم الإغلاق'}</td>
                        </tr>
                        <tr>
                            <td><strong>الحالة:</strong></td>
                            <td>${yearData.status === 'open' ? 'مفتوحة' : 'مغلقة'}</td>
                        </tr>
                    </table>
                </div>
                
                <div style="margin: 20px 0;">
                    <table>
                        <tr>
                            <td><strong>إجمالي المبيعات:</strong></td>
                            <td>${yearData.totalSales.toLocaleString()} ر.س</td>
                        </tr>
                        <tr>
                            <td><strong>إجمالي المصاريف:</strong></td>
                            <td>${yearData.totalExpenses.toLocaleString()} ر.س</td>
                        </tr>
                        <tr style="border-top: 2px solid #333;">
                            <td><strong>صافي الدخل:</strong></td>
                            <td style="color: ${yearData.netProfit >= 0 ? '#27ae60' : '#e74c3c'};">${yearData.netProfit.toLocaleString()} ر.س</td>
                        </tr>
                    </table>
                </div>
                
                ${yearData.notes ? `
                    <div style="margin-top: 20px;">
                        <h4>ملاحظات:</h4>
                        <p>${yearData.notes}</p>
                    </div>
                ` : ''}
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>طباعة تقرير السنة المالية</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
                        .company-report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #ddd; padding-bottom: 20px; }
                        .report-logo { max-width: 150px; max-height: 150px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #ddd; }
                    </style>
                </head>
                <body>
                    ${printHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // ========== صفحة التقارير ==========
        function loadReportsPage() {
            return `
                <div class="page-header">
                    <h2><i class="fas fa-chart-bar"></i> التقارير</h2>
                </div>
                
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showReportTab('salesReport')">
                        <i class="fas fa-chart-line"></i> تقرير المبيعات
                    </button>
                    <button class="tab-btn" onclick="showReportTab('productionReport')">
                        <i class="fas fa-industry"></i> تقرير الإنتاج
                    </button>
                    <button class="tab-btn" onclick="showReportTab('inventoryReport')">
                        <i class="fas fa-boxes"></i> تقرير المخزون
                    </button>
                    <button class="tab-btn" onclick="showReportTab('customersReport')">
                        <i class="fas fa-users"></i> تقرير العملاء
                    </button>
                    <button class="tab-btn" onclick="showReportTab('incomeStatement')">
                        <i class="fas fa-file-invoice-dollar"></i> قائمة الدخل
                    </button>
                </div>
                
                <div id="reportContent">
                    <!-- سيتم عرض التقرير هنا -->
                </div>
            `;
        }
        
        function loadReportsData() {
            showReportTab('salesReport');
        }
        
        function showReportTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            switch(tabName) {
                case 'salesReport':
                    showSalesReport();
                    break;
                case 'productionReport':
                    showProductionReport();
                    break;
                case 'inventoryReport':
                    showInventoryReport();
                    break;
                case 'customersReport':
                    showCustomersReport();
                    break;
                case 'incomeStatement':
                    showIncomeStatement();
                    break;
            }
        }
        
        function showSalesReport() {
            const today = new Date().toISOString().split('T')[0];
            
            let reportHTML = `
                <div class="form-container">
                    <h3><i class="fas fa-chart-line"></i> تقرير المبيعات</h3>
                    
                    <div class="filter-container">
                        <div class="filter-row">
                            <div class="form-group">
                                <label>من تاريخ:</label>
                                <input type="date" id="salesReportFromDate">
                            </div>
                            <div class="form-group">
                                <label>إلى تاريخ:</label>
                                <input type="date" id="salesReportToDate" value="${today}">
                            </div>
                            <div class="form-group">
                                <label>العميل:</label>
                                <select id="salesReportCustomer">
                                    <option value="">جميع العملاء</option>
                                    ${loadData('customers').map(customer => `
                                        <option value="${customer.id}">${customer.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>الصنف:</label>
                                <select id="salesReportItem">
                                    <option value="">جميع الأصناف</option>
                                    ${loadData('items').map(item => `
                                        <option value="${item.id}">${item.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn" onclick="generateSalesReport()">
                                    <i class="fas fa-filter"></i> توليد التقرير
                                </button>
                                <button class="btn btn-info" onclick="printSalesReport()" style="margin-right: 10px;">
                                    <i class="fas fa-print"></i> طباعة التقرير
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="salesReportResults">
                        <!-- سيتم عرض نتائج التقرير هنا -->
                    </div>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = reportHTML;
            generateSalesReport();
        }
        
        function generateSalesReport() {
            const fromDate = document.getElementById('salesReportFromDate').value;
            const toDate = document.getElementById('salesReportToDate').value || new Date().toISOString().split('T')[0];
            const customerId = document.getElementById('salesReportCustomer').value;
            const itemId = document.getElementById('salesReportItem').value;
            
            let sales = loadData('sales').filter(sale => !sale.isReturn && sale.financialYear === currentFinancialYear);
            
            if (fromDate) {
                sales = sales.filter(s => s.date >= fromDate);
            }
            
            if (toDate) {
                sales = sales.filter(s => s.date <= toDate);
            }
            
            if (customerId) {
                sales = sales.filter(s => s.customerId == customerId);
            }
            
            let totalSales = 0;
            let totalTax = 0;
            let totalSubtotal = 0;
            let itemSales = {};
            
            sales.forEach(sale => {
                totalSales += sale.total;
                totalTax += sale.tax;
                totalSubtotal += sale.subtotal;
                
                sale.items.forEach(item => {
                    if (itemId && item.itemId != itemId) return;
                    
                    if (!itemSales[item.itemId]) {
                        itemSales[item.itemId] = {
                            name: item.itemName,
                            quantity: 0,
                            total: 0
                        };
                    }
                    itemSales[item.itemId].quantity += item.quantity;
                    itemSales[item.itemId].total += item.total;
                });
            });
            
            const completedSales = sales.filter(s => s.status === 'completed').length;
            const pendingSales = sales.filter(s => s.status === 'pending').length;
            
            let resultsHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; text-align: center;">
                            <div>إجمالي المبيعات</div>
                            <div class="summary-value">${totalSales.toLocaleString()} ر.س</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center;">
                            <div>إجمالي الضريبة</div>
                            <div class="summary-value">${totalTax.toLocaleString()} ر.س</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div style="background: #fff3cd; padding: 15px; border-radius: 10px; text-align: center;">
                            <div>صافي المبيعات</div>
                            <div class="summary-value">${totalSubtotal.toLocaleString()} ر.س</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 10px; text-align: center;">
                            <div>عدد الفواتير</div>
                            <div class="summary-value">${sales.length}</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; text-align: center;">
                            <div>فواتير مكتملة</div>
                            <div class="summary-value">${completedSales}</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div style="background: #ffebee; padding: 15px; border-radius: 10px; text-align: center;">
                            <div>فواتير معلقة</div>
                            <div class="summary-value">${pendingSales}</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (Object.keys(itemSales).length > 0) {
                resultsHTML += `
                    <h4 style="margin-top: 20px;">المبيعات حسب الأصناف</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية المباعة</th>
                                <th>إجمالي المبيعات</th>
                                <th>نسبة المبيعات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                Object.values(itemSales).forEach(item => {
                    const percentage = totalSubtotal > 0 ? ((item.total / totalSubtotal) * 100).toFixed(1) : 0;
                    resultsHTML += `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.quantity.toLocaleString()}</td>
                            <td>${item.total.toLocaleString()} ر.س</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                resultsHTML += `</tbody></table>`;
            }
            
            document.getElementById('salesReportResults').innerHTML = resultsHTML;
        }
        
        function printSalesReport() {
            const fromDate = document.getElementById('salesReportFromDate').value;
            const toDate = document.getElementById('salesReportToDate').value || new Date().toISOString().split('T')[0];
            const customerId = document.getElementById('salesReportCustomer').value;
            const itemId = document.getElementById('salesReportItem').value;
            
            let sales = loadData('sales').filter(sale => !sale.isReturn && sale.financialYear === currentFinancialYear);
            let customers = loadData('customers');
            let selectedCustomer = '';
            
            if (fromDate) {
                sales = sales.filter(s => s.date >= fromDate);
            }
            
            if (toDate) {
                sales = sales.filter(s => s.date <= toDate);
            }
            
            if (customerId) {
                sales = sales.filter(s => s.customerId == customerId);
                const customer = customers.find(c => c.id == customerId);
                selectedCustomer = customer ? customer.name : '';
            }
            
            let totalSales = 0;
            let totalTax = 0;
            let totalSubtotal = 0;
            let itemSales = {};
            
            sales.forEach(sale => {
                totalSales += sale.total;
                totalTax += sale.tax;
                totalSubtotal += sale.subtotal;
                
                sale.items.forEach(item => {
                    if (itemId && item.itemId != itemId) return;
                    
                    if (!itemSales[item.itemId]) {
                        itemSales[item.itemId] = {
                            name: item.itemName,
                            quantity: 0,
                            total: 0
                        };
                    }
                    itemSales[item.itemId].quantity += item.quantity;
                    itemSales[item.itemId].total += item.total;
                });
            });
            
            let printHTML = `
                <div class="company-report-header">
                    ${companyInfo.logo ? `<img src="${companyInfo.logo}" class="report-logo" alt="شعار الشركة">` : '<h2>' + companyInfo.name + '</h2>'}
                    <p>${companyInfo.address}</p>
                    <p>هاتف: ${companyInfo.phone} | البريد: ${companyInfo.email}</p>
                    <hr>
                    <h3>تقرير المبيعات</h3>
                    <p>من ${fromDate || 'البداية'} إلى ${toDate}</p>
                    ${selectedCustomer ? `<p>العميل: ${selectedCustomer}</p>` : ''}
                    <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <table>
                        <tr>
                            <td><strong>إجمالي المبيعات:</strong></td>
                            <td>${totalSales.toLocaleString()} ر.س</td>
                        </tr>
                        <tr>
                            <td><strong>إجمالي الضريبة:</strong></td>
                            <td>${totalTax.toLocaleString()} ر.س</td>
                        </tr>
                        <tr>
                            <td><strong>صافي المبيعات:</strong></td>
                            <td>${totalSubtotal.toLocaleString()} ر.س</td>
                        </tr>
                        <tr>
                            <td><strong>عدد الفواتير:</strong></td>
                            <td>${sales.length}</td>
                        </tr>
                    </table>
                </div>
            `;
            
            if (Object.keys(itemSales).length > 0) {
                printHTML += `
                    <h4>المبيعات حسب الأصناف</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية المباعة</th>
                                <th>إجمالي المبيعات</th>
                                <th>نسبة المبيعات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                Object.values(itemSales).forEach(item => {
                    const percentage = totalSubtotal > 0 ? ((item.total / totalSubtotal) * 100).toFixed(1) : 0;
                    printHTML += `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.quantity.toLocaleString()}</td>
                            <td>${item.total.toLocaleString()} ر.س</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                printHTML += `</tbody></table>`;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>طباعة تقرير المبيعات</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
                        .company-report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #ddd; padding-bottom: 20px; }
                        .report-logo { max-width: 150px; max-height: 150px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #ddd; }
                        th { background: #f8f9fa; }
                    </style>
                </head>
                <body>
                    ${printHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // ========== صفحة إدارة المستخدمين ==========
        function loadUsersPage() {
            if (currentUser.role !== 'admin') {
                return `
                    <div class="page-header">
                        <h2><i class="fas fa-user-cog"></i> إدارة المستخدمين</h2>
                    </div>
                    <div class="data-empty">
                        <i class="fas fa-lock"></i>
                        <p>ليس لديك صلاحية للوصول إلى هذه الصفحة</p>
                    </div>
                `;
            }
            
            return `
                <div class="page-header">
                    <h2><i class="fas fa-user-cog"></i> إدارة المستخدمين</h2>
                    <button class="btn" onclick="showUserForm()">
                        <i class="fas fa-plus"></i> إضافة مستخدم جديد
                    </button>
                </div>
                
                <div class="form-container" id="userForm" style="display: none;">
                    <h3><i class="fas fa-plus-circle"></i> ${currentUserId ? 'تعديل مستخدم' : 'إضافة مستخدم جديد'}</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>اسم المستخدم:</label>
                            <input type="text" id="userUsername" placeholder="اسم المستخدم">
                        </div>
                        <div class="form-group">
                            <label>الاسم الكامل:</label>
                            <input type="text" id="userName" placeholder="الاسم الكامل">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>البريد الإلكتروني:</label>
                            <input type="email" id="userEmail" placeholder="البريد الإلكتروني">
                        </div>
                        <div class="form-group">
                            <label>الدور:</label>
                            <select id="userRole">
                                <option value="admin">مدير</option>
                                <option value="user">مستخدم</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>كلمة المرور:</label>
                            <input type="password" id="userPassword" placeholder="كلمة المرور">
                        </div>
                        <div class="form-group">
                            <label>تأكيد كلمة المرور:</label>
                            <input type="password" id="userConfirmPassword" placeholder="تأكيد كلمة المرور">
                        </div>
                    </div>
                    <button class="btn" onclick="saveUser()">
                        <i class="fas fa-save"></i> ${currentUserId ? 'تحديث' : 'حفظ'}
                    </button>
                    <button class="btn btn-secondary" onclick="hideUserForm()" style="margin-right: 10px;">
                        إلغاء
                    </button>
                </div>
                
                <div id="usersTableContainer">
                    <!-- سيتم تحميل البيانات -->
                </div>
            `;
        }
        
        let currentUserId = null;
        
        function loadUsersData() {
            if (currentUser.role !== 'admin') return;
            
            const users = loadData('users');
            let usersTableHTML = '';
            
            if (users.length > 0) {
                usersTableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>اسم المستخدم</th>
                                <th>الاسم الكامل</th>
                                <th>البريد الإلكتروني</th>
                                <th>الدور</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                users.forEach(user => {
                    if (user.id !== currentUser.id) {
                        usersTableHTML += `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.name}</td>
                                <td>${user.email}</td>
                                <td>${user.role === 'admin' ? 'مدير' : 'مستخدم'}</td>
                                <td class="action-buttons">
                                    <button class="btn" onclick="editUser(${user.id})" style="padding: 5px 10px;">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteUser(${user.id})" style="padding: 5px 10px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                });
                
                usersTableHTML += `</tbody></table>`;
            } else {
                usersTableHTML = '<div class="data-empty"><i class="fas fa-users"></i><p>لا توجد مستخدمين مسجلين</p></div>';
            }
            
            document.getElementById('usersTableContainer').innerHTML = usersTableHTML;
        }
        
        function showUserForm() {
            if (currentUser.role !== 'admin') return;
            document.getElementById('userForm').style.display = 'block';
        }
        
        function hideUserForm() {
            document.getElementById('userForm').style.display = 'none';
            currentUserId = null;
            resetUserForm();
        }
        
        function resetUserForm() {
            document.getElementById('userUsername').value = '';
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userRole').value = 'user';
            document.getElementById('userPassword').value = '';
            document.getElementById('userConfirmPassword').value = '';
        }
        
        function saveUser() {
            if (currentUser.role !== 'admin') return;
            
            const username = document.getElementById('userUsername').value.trim();
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const confirmPassword = document.getElementById('userConfirmPassword').value;
            const role = document.getElementById('userRole').value;
            
            if (!username || !name || !role) {
                showNotification('يرجى إدخال جميع البيانات المطلوبة', 'error');
                return;
            }
            
            if (!currentUserId && (!password || password.length < 6)) {
                showNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('كلمات المرور غير متطابقة', 'error');
                return;
            }
            
            let users = loadData('users');
            
            if (!currentUserId && users.some(u => u.username === username)) {
                showNotification('اسم المستخدم موجود مسبقاً', 'error');
                return;
            }
            
            const user = {
                id: currentUserId || Date.now(),
                username: username,
                name: name,
                email: email,
                role: role,
                avatar: name.charAt(0),
                createdAt: new Date().toISOString()
            };
            
            if (password) {
                user.password = password;
            }
            
            if (currentUserId) {
                const index = users.findIndex(u => u.id === currentUserId);
                if (index !== -1) {
                    if (!password) {
                        user.password = users[index].password;
                    }
                    users[index] = user;
                }
            } else {
                users.push(user);
            }
            
            saveData('users', users);
            
            hideUserForm();
            loadUsersData();
            showNotification(currentUserId ? 'تم تعديل المستخدم' : 'تم إضافة المستخدم بنجاح', 'success');
        }
        
        function editUser(id) {
            if (currentUser.role !== 'admin') return;
            
            const users = loadData('users');
            const user = users.find(u => u.id === id);
            
            if (user) {
                currentUserId = id;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userRole').value = user.role;
                document.getElementById('userPassword').value = '';
                document.getElementById('userConfirmPassword').value = '';
                showUserForm();
            }
        }
        
        function deleteUser(id) {
            if (currentUser.role !== 'admin') return;
            
            if (id === currentUser.id) {
                showNotification('لا يمكن حذف المستخدم الحالي', 'error');
                return;
            }
            
            if (confirm('هل تريد حذف هذا المستخدم؟')) {
                let users = loadData('users');
                users = users.filter(u => u.id !== id);
                saveData('users', users);
                loadUsersData();
                showNotification('تم حذف المستخدم', 'success');
            }
        }
        
        // ========== صفحة الإعدادات ==========
        function loadSettingsPage() {
            if (currentUser.role !== 'admin') {
                return `
                    <div class="page-header">
                        <h2><i class="fas fa-cog"></i> الإعدادات</h2>
                    </div>
                    <div class="data-empty">
                        <i class="fas fa-lock"></i>
                        <p>ليس لديك صلاحية للوصول إلى هذه الصفحة</p>
                    </div>
                `;
            }
            
            return `
                <div class="page-header">
                    <h2><i class="fas fa-cog"></i> إعدادات النظام</h2>
                </div>
                
                <div class="form-container">
                    <h3><i class="fas fa-building"></i> معلومات الشركة</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>اسم الشركة:</label>
                            <input type="text" id="companyName" placeholder="اسم الشركة" value="${companyInfo.name}">
                        </div>
                        <div class="form-group">
                            <label>الهاتف:</label>
                            <input type="text" id="companyPhone" placeholder="رقم الهاتف" value="${companyInfo.phone}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>البريد الإلكتروني:</label>
                            <input type="email" id="companyEmail" placeholder="البريد الإلكتروني" value="${companyInfo.email}">
                        </div>
                        <div class="form-group">
                            <label>الرقم الضريبي:</label>
                            <input type="text" id="companyTaxNumber" placeholder="الرقم الضريبي" value="${companyInfo.taxNumber}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>نسبة الضريبة:</label>
                            <input type="number" id="companyTaxRate" placeholder="نسبة الضريبة" step="0.1" value="${companyInfo.taxRate || 15}">%
                        </div>
                        <div class="form-group">
                            <label>سعر صرف الريال:</label>
                            <input type="number" id="companyExchangeRate" placeholder="سعر الصرف" step="0.001" value="${companyInfo.exchangeRate || 1}">
                            <small style="color: #666;">(يستخدم لحساب متوسط سعر التكلفة)</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>العنوان:</label>
                        <textarea id="companyAddress" rows="2" placeholder="عنوان الشركة">${companyInfo.address}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>شعار الشركة:</label>
                        <div class="logo-preview" id="logoPreview">
                            ${companyInfo.logo ? `<img src="${companyInfo.logo}" alt="شعار الشركة">` : '<i class="fas fa-building"></i>'}
                        </div>
                        <div class="file-input-container">
                            <input type="file" id="logoUpload" accept="image/*" onchange="previewLogo(event)">
                            <label for="logoUpload" class="file-input-label">
                                <i class="fas fa-upload"></i> رفع صورة شعار
                            </label>
                        </div>
                        <small style="color: #666;">(يفضل صورة بحجم 150x150 بكسل)</small>
                    </div>
                    
                    <button class="btn" onclick="saveCompanyInfo()">
                        <i class="fas fa-save"></i> حفظ معلومات الشركة
                    </button>
                </div>
                
                <div class="form-container">
                    <h3><i class="fas fa-database"></i> إدارة البيانات</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <button class="btn btn-warning" onclick="backupData()">
                                <i class="fas fa-download"></i> نسخ احتياطي للبيانات
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-danger" onclick="confirmResetData()">
                                <i class="fas fa-trash"></i> مسح جميع البيانات
                            </button>
                        </div>
                    </div>
                    <div class="warning-box">
                        <p><i class="fas fa-exclamation-triangle"></i> <strong>تنبيه:</strong> مسح البيانات سيزيل جميع المعلومات ولا يمكن التراجع عنه.</p>
                    </div>
                </div>
            `;
        }
        
        function loadSettingsData() {
            // لا حاجة لتحميل بيانات إضافية
        }
        
        function previewLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const logoPreview = document.getElementById('logoPreview');
                    logoPreview.innerHTML = `<img src="${e.target.result}" alt="شعار الشركة">`;
                    companyInfo.logo = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function saveCompanyInfo() {
            if (currentUser.role !== 'admin') return;
            
            companyInfo.name = document.getElementById('companyName').value.trim();
            companyInfo.phone = document.getElementById('companyPhone').value.trim();
            companyInfo.email = document.getElementById('companyEmail').value.trim();
            companyInfo.taxNumber = document.getElementById('companyTaxNumber').value.trim();
            companyInfo.taxRate = parseFloat(document.getElementById('companyTaxRate').value) || 15;
            companyInfo.address = document.getElementById('companyAddress').value.trim();
            companyInfo.exchangeRate = parseFloat(document.getElementById('companyExchangeRate').value) || 1;
            
            saveData('companyInfo', companyInfo);
            updateCompanyUI();
            showNotification('تم حفظ معلومات الشركة بنجاح', 'success');
        }
        
        function backupData() {
            const data = {
                companyInfo: companyInfo,
                financialYears: financialYears,
                items: loadData('items'),
                customers: loadData('customers'),
                sales: loadData('sales'),
                salesOrders: loadData('salesOrders'),
                production: loadData('production'),
                expenses: loadData('expenses'),
                productionCosts: loadData('productionCosts'),
                users: loadData('users'),
                payments: loadData('payments')
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('تم إنشاء نسخة احتياطية بنجاح', 'success');
        }
        
        function confirmResetData() {
            if (confirm('هل أنت متأكد من مسح جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                if (confirm('هل أنت متأكد تماماً؟ سيتم حذف جميع المبيعات والعملاء والأصناف...')) {
                    resetAllData();
                }
            }
        }
        
        function resetAllData() {
            localStorage.clear();
            initializeSystem();
            showNotification('تم مسح جميع البيانات وإعادة التهيئة', 'success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
        
        // ========== وظائف مساعدة ==========
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'success' ? '#27ae60' : 
                                          type === 'error' ? '#e74c3c' : 
                                          type === 'warning' ? '#f39c12' : '#3498db';
            
            notification.innerHTML = `
                <div>
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    ${message}
                </div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }
        
        // ========== تهيئة النظام عند التحميل ==========
        window.onload = function() {
            initializeSystem();
        };
    </script>
</body>
</html>
